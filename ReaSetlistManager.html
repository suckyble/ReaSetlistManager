<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ReaSetlistManager (Retro)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="main.js"></script>
    <script src="Sortable.min.js"></script>
    
    <style>
        /* --- GLOBAL & THEME --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: sans-serif; /* Safe font */
            background: #111;
            color: #eee; margin: 0; padding-bottom: 80px; user-select: none;
            min-height: 100vh;
        }

        /* --- CONTROLS AREA --- */
        .controls { 
            position: sticky; top: 0; z-index: 100; 
            background: #1a1a2e;
            padding: 16px; 
            border-bottom: 2px solid #0f3460;
            display: -webkit-flex; display: flex; /* Flexbox prefix for old android */
            -webkit-flex-direction: column; flex-direction: column; 
            gap: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.6);
        }

        /* Setlist Manager Row */
        .setlist-row { 
            display: -webkit-flex; display: flex; gap: 8px; 
            background: rgba(42, 42, 42, 0.6); 
            padding: 10px; 
            border-radius: 12px; 
            align-items: center; 
            border: 1px solid rgba(255, 255, 255, 0.1);
            -webkit-flex-wrap: wrap; flex-wrap: wrap;
        }
        .setlist-select {
            -webkit-flex-grow: 1; flex-grow: 1; padding: 10px 12px; 
            background: rgba(17, 17, 17, 0.8);
            color: #fff; 
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px; 
            font-size: 14px; 
            outline: none; 
            min-width: 100px;
        }
        .btn-mini {
            padding: 10px 14px; 
            font-weight: bold; 
            cursor: pointer; 
            border: 1px solid transparent;
            background: rgba(51, 51, 51, 0.8);
            color: #ccc; 
            border-radius: 8px; 
            font-size: 14px;
        }
        .btn-add { background: #2e7d32; color: white; }
        .btn-del { background: #c62828; color: white; }
        .btn-exp { background: #1565C0; color: white; }
        .btn-imp { background: #EF6C00; color: white; }

        /* Transport Row */
        .transport-row { display: -webkit-flex; display: flex; gap: 12px; width: 100%; }
        .btn-transport { 
            -webkit-flex: 1; flex: 1; padding: 16px 0; font-size: 16px; font-weight: bold; 
            cursor: pointer; border-radius: 10px; border: none; color: white;
            position: relative; overflow: hidden;
        }
        .btn-play { background: #1b5e20; }
        .btn-stop { background: #b71c1c; }
        .btn-refresh { background: #37474f; }

        /* Toggles Row */
        .toggles-row { 
            display: -webkit-flex; display: flex; justify-content: space-around; 
            background: rgba(37, 37, 37, 0.6);
            padding: 12px; border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .toggle-wrapper { 
            display: -webkit-flex; display: flex; align-items: center; gap: 10px; 
            font-size: 11px; text-transform: uppercase; color: #aaa;
            font-weight: 600; letter-spacing: 0.5px;
        }
        .help-icon {
            display: inline-block; width: 18px; height: 18px; 
            border-radius: 50%; text-align: center; line-height: 18px;
            background: #37474f; color: #fff; font-weight: bold; font-size: 11px;
            cursor: pointer; margin-left: 2px; border: 1px solid #555;
        }

        /* Switches */
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { 
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; 
            background: #37474f; transition: .4s; border-radius: 34px;
        }
        .slider:before { 
            position: absolute; content: ""; height: 16px; width: 16px; 
            left: 3px; bottom: 3px; background-color: white; 
            transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background: #2196F3; }
        input:checked + .slider:before { transform: translateX(18px); -webkit-transform: translateX(18px); }

        /* --- SETLIST LIST --- */
        #setlist { 
            list-style: none; padding: 16px; margin: 0; 
            counter-reset: song-counter; 
        }
        .region-item { 
            background: #252525;
            margin-bottom: 12px; padding: 14px; border-radius: 12px;
            display: -webkit-flex; display: flex; align-items: center; gap: 12px; 
            border-left: 4px solid #37474f;
            counter-increment: song-counter; 
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .region-item.active { 
            background: #1e331e; border-left-color: #00e676;
        }
        .region-item.queued { 
            border-left-color: #ffd54f; background: #332a00;
        }
        
        .region-item.skipped {
            opacity: 0.4; border-left-color: #444; background: #1a1a1a;
        }
        .region-item.sortable-drag { opacity: 0; }
        
        .region-index {
            font-size: 20px; font-weight: 800; color: #546e7a; 
            min-width: 30px; text-align: center;
        }
        .region-index::before { content: counter(song-counter); }

        .drag-handle { 
            font-size: 24px; color: #607d8b; padding: 5px; 
            cursor: grab; line-height: 1;
        }
        
        .song-info { -webkit-flex-grow: 1; flex-grow: 1; min-width: 0; }
        .song-header { display: -webkit-flex; display: flex; justify-content: space-between; margin-bottom: 8px; }
        .song-name { font-weight: 600; color: #fff; font-size: 1.1em; }
        .song-duration { 
            font-family: monospace; color: #90a4ae; font-weight: 500; font-size: 0.95em;
            min-width: 50px; text-align: right;
        }
        .song-duration.live-time { color: #00e676; font-weight: 800; }
        
        .progress-bg { 
            background: #111; height: 6px; width: 100%; border-radius: 10px; 
            overflow: hidden; 
        }
        .progress-fill { 
            background: #00e676; height: 100%; width: 0%; 
        }
        
        .song-actions { display: -webkit-flex; display: flex; -webkit-flex-direction: column; flex-direction: column; gap: 8px; align-items: flex-end; }
        .btn-row-group { display: -webkit-flex; display: flex; gap: 6px; width: 100%; }

        .load-btn { 
            background: #102030; color: #64b5f6; border: 1px solid #333;
            border-radius: 8px; padding: 8px 14px; font-size: 12px; font-weight: bold;
            white-space: nowrap; cursor: pointer; width: 100%;
        }
        .load-btn:active { background: #2196F3; color: white; }

        .chain-btn, .skip-btn {
            background: #333; color: #78909c;
            border: 1px solid #444; border-radius: 8px; 
            padding: 6px; width: 50%; text-align: center; cursor: pointer;
            font-weight: bold;
        }
        .chain-btn.linked { background: #1b5e20; color: #a5d6a7; border-color: #2e7d32; }
        #setlist .region-item:last-child .chain-btn { visibility: hidden; pointer-events: none; }

        .skip-btn.skipped { background: #b71c1c; color: #ef9a9a; border-color: #c62828; }

    </style>
</head>
<body>

<div class="controls">
    <div class="setlist-row">
        <select id="setlistSelect" class="setlist-select" onchange="changeSetlist()"></select>
        <button class="btn-mini btn-add" onclick="createSetlist()">+</button>
        <button class="btn-mini btn-del" onclick="deleteSetlist()">&#10005;</button>
        <button class="btn-mini btn-exp" onclick="exportSetlists()">&#8595;</button>
        <button class="btn-mini btn-imp" onclick="triggerImport()">&#8593;</button>
        <input type="file" id="importInput" style="display:none" accept=".json" onchange="importSetlists(this)">
    </div>

    <div class="transport-row">
        <button class="btn-transport btn-play" onclick="togglePlay()">&#9654; PLAY</button>
        <button class="btn-transport btn-stop" onclick="smartStop()">&#9632; STOP</button>
        <button class="btn-transport btn-refresh" onclick="wwr_start()">&#8635; RESYNC</button>
    </div>

    <div class="toggles-row">
        <div class="toggle-wrapper">
            <label class="switch"><input type="checkbox" id="autoScrollToggle" checked><span class="slider round"></span></label>
            <span>Scroll</span>
        </div>
        <div class="toggle-wrapper">
            <label class="switch"><input type="checkbox" id="queueModeToggle"><span class="slider round"></span></label>
            <span>Queue</span>
        </div>
        <div class="toggle-wrapper">
            <label class="switch"><input type="checkbox" id="autoStopToggle" checked><span class="slider round"></span></label>
            <span>AutoStop</span>
        </div>
    </div>
</div>

<ul id="setlist"></ul>

<script type="text/javascript">
    // --- 0. ES5 POLYFILLS (For Old Android) ---
    if (!Array.prototype.find) {
        Array.prototype.find = function(predicate) {
            if (this == null) throw new TypeError('Array.prototype.find called on null or undefined');
            if (typeof predicate !== 'function') throw new TypeError('predicate must be a function');
            var list = Object(this);
            var length = list.length >>> 0;
            var thisArg = arguments[1];
            for (var i = 0; i < length; i++) {
                var value = list[i];
                if (predicate.call(thisArg, value, i, list)) return value;
            }
            return undefined;
        };
    }
    if (!Array.prototype.findIndex) {
        Array.prototype.findIndex = function(predicate) {
            if (this == null) throw new TypeError('Array.prototype.findIndex called on null or undefined');
            if (typeof predicate !== 'function') throw new TypeError('predicate must be a function');
            var list = Object(this);
            var length = list.length >>> 0;
            var thisArg = arguments[1];
            for (var i = 0; i < length; i++) {
                var value = list[i];
                if (predicate.call(thisArg, value, i, list)) return i;
            }
            return -1;
        };
    }

    // --- 1. REAPER CONNECTION ---
    wwr_req_recur("TRANSPORT", 100);
    wwr_req_recur("REGION", 1000); 
    wwr_start(); 

    // --- 2. STATE (Using var for compat) ---
    var g_regions = [];      
    var displayList = [];    
    var isPlaying = false;
    var currentPos = 0.0;
    var queuedRegion = null;
    var lastActiveID = null;
    var lastRenderChecksum = "";
    var isDragging = false;
    var initialized = false;

    // STORAGE
    var STORAGE_KEY = "reaper_setlists_v9"; 
    var CURRENT_KEY = "reaper_current_setlist";

    // LOAD
    var setlists = JSON.parse(localStorage.getItem(STORAGE_KEY)) || { "Default": [] };
    var currentSetlistName = localStorage.getItem(CURRENT_KEY) || "Default";
    
    if (!setlists["Default"]) setlists["Default"] = [];
    if (!setlists[currentSetlistName]) currentSetlistName = "Default";

    updateSetlistDropdown();

    // --- 3. LISTENER ---
    function wwr_onreply(results) {
        if (isDragging) return;

        var ar = results.split("\n");
        for (var x = 0; x < ar.length; x++) {
            var tok = ar[x].split("\t");
            if (tok.length > 0) {
                if (tok[0] === "TRANSPORT") {
                    isPlaying = (tok[1] & 1) == 1;
                    currentPos = parseFloat(tok[2]);
                    updatePlaybackUI(); 
                }
                else if (tok[0] === "REGION_LIST") g_regions = [];
                else if (tok[0] === "REGION") g_regions.push(tok);
                else if (tok[0] === "REGION_LIST_END") syncRegions();
            }
        }
    }

    // --- 4. SYNC LOGIC ---
    function syncRegions() {
        if (isDragging) return;

        // Use Object instead of Map
        var reaperMap = {};
        for (var i = 0; i < g_regions.length; i++) {
            var r = g_regions[i];
            if (r.length > 4) {
                // r[2] is ID
                reaperMap[r[2]] = { 
                    name: r[1],
                    id: r[2],
                    start: parseFloat(r[3]),
                    end: parseFloat(r[4]),
                    duration: parseFloat(r[4]) - parseFloat(r[3])
                };
            }
        }

        if (displayList.length === 0 && !initialized) {
            var savedList = setlists[currentSetlistName];
            
            // Build from save
            for (var j = 0; j < savedList.length; j++) {
                var item = savedList[j];
                if (reaperMap.hasOwnProperty(item.id)) {
                    var rData = reaperMap[item.id];
                    rData.chain = item.chain;
                    rData.skipped = (item.skipped === true);
                    displayList.push(rData);
                    delete reaperMap[item.id];
                }
            }
            
            // Add new items
            var newItems = [];
            for (var key in reaperMap) {
                if (reaperMap.hasOwnProperty(key)) newItems.push(reaperMap[key]);
            }
            newItems.sort(function(a,b) { return a.start - b.start; });
            
            for (var k = 0; k < newItems.length; k++) {
                var d = newItems[k];
                d.chain = false;
                d.skipped = false;
                displayList.push(d);
            }
            
            // Auto-Init
            if (displayList.length > 0 && !isPlaying) {
                wwr_req("SET/POS/" + displayList[0].start);
            }
            initialized = true;
        } 
        else {
            var activeIDs = {}; // Object as Set
            
            for (var m = 0; m < displayList.length; m++) {
                var item = displayList[m];
                if (reaperMap.hasOwnProperty(item.id)) {
                    var rData = reaperMap[item.id];
                    item.name = rData.name;
                    item.start = rData.start;
                    item.end = rData.end;
                    item.duration = rData.duration;
                    activeIDs[item.id] = true;
                    delete reaperMap[item.id];
                }
            }

            // Filter dead items
            var filtered = [];
            for (var n = 0; n < displayList.length; n++) {
                var it = displayList[n];
                if (activeIDs[it.id] || reaperMap.hasOwnProperty(it.id)) {
                    filtered.push(it);
                }
            }
            displayList = filtered;

            // Add new items
            var newItems2 = [];
            for (var key2 in reaperMap) {
                if (reaperMap.hasOwnProperty(key2)) newItems2.push(reaperMap[key2]);
            }
            newItems2.sort(function(a,b) { return a.start - b.start; });
            
            for (var p = 0; p < newItems2.length; p++) {
                var d2 = newItems2[p];
                d2.chain = false; 
                d2.skipped = false;
                displayList.push(d2);
            }
        }

        saveCurrentState();
        
        var currentChecksum = JSON.stringify(displayList.map(function(r){ 
            return { id: r.id, chain: r.chain, skipped: r.skipped, name: r.name }; 
        }));
        
        if (currentChecksum !== lastRenderChecksum) {
            lastRenderChecksum = currentChecksum;
            renderSetlist();
            updatePlaybackUI();
        }
    }

    function saveCurrentState() {
        var storageFormat = displayList.map(function(r){ 
            return { id: r.id, chain: r.chain, skipped: r.skipped }; 
        });
        setlists[currentSetlistName] = storageFormat;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(setlists));
        localStorage.setItem(CURRENT_KEY, currentSetlistName);
    }

    // --- 5. RENDER ---
    function formatTime(seconds) {
        var m = Math.floor(seconds / 60);
        var s = Math.round(seconds % 60);
        return m + ":" + (s < 10 ? '0' : '') + s;
    }

    function renderSetlist() {
        var listEl = document.getElementById('setlist');
        var scrollPos = listEl.scrollTop;
        listEl.innerHTML = "";
        
        for(var i=0; i<displayList.length; i++) {
            var r = displayList[i];
            var li = document.createElement("li");
            li.className = "region-item" + (r.skipped ? " skipped" : "");
            li.id = "row-" + r.id;
            li.setAttribute("data-id", r.id);
            // We only need ID for logic, state is in displayList
            
            var chainIcon = r.chain ? "&#10140;" : "&#9632;";
            var chainClass = r.chain ? "chain-btn linked" : "chain-btn";
            
            var skipIcon = r.skipped ? "&#10004;" : "&#10006;";
            var skipClass = r.skipped ? "skip-btn skipped" : "skip-btn";
            
            // HTML String
            var html = '';
            html += '<div class="region-index"></div>';
            html += '<div class="drag-handle">&#9776;</div>';
            html += '<div class="song-info">';
            html += '  <div class="song-header">';
            html += '    <span class="song-name">' + r.name + '</span>';
            html += '    <span class="song-duration" id="dur-' + r.id + '" data-length="' + formatTime(r.duration) + '">' + formatTime(r.duration) + '</span>';
            html += '  </div>';
            html += '  <div class="progress-bg"><div class="progress-fill" id="prog-' + r.id + '"></div></div>';
            html += '</div>';
            html += '<div class="song-actions">';
            html += '  <div class="btn-row-group">';
            html += '    <button class="' + chainClass + '" onclick="toggleChain(\'' + r.id + '\')">' + chainIcon + '</button>';
            html += '    <button class="' + skipClass + '" onclick="toggleSkip(\'' + r.id + '\')">' + skipIcon + '</button>';
            html += '  </div>';
            html += '  <button class="load-btn" onclick="playRegion(' + r.start + ', \'' + r.id + '\')">PLAY NEXT</button>';
            html += '</div>';
            
            li.innerHTML = html;
            listEl.appendChild(li);
        }
        
        listEl.scrollTop = scrollPos;
    }

    // --- 6. ACTIONS ---
    function toggleChain(id) {
        // ES5 find replacement
        var item = null;
        for(var i=0; i<displayList.length; i++) {
            if(displayList[i].id == id) { item = displayList[i]; break; }
        }
        
        if (item) {
            item.chain = !item.chain;
            saveCurrentState();
            lastRenderChecksum = ""; 
            syncRegions();
        }
    }

    function toggleSkip(id) {
        var item = null;
        for(var i=0; i<displayList.length; i++) {
            if(displayList[i].id == id) { item = displayList[i]; break; }
        }
        
        if (item) {
            item.skipped = !item.skipped;
            saveCurrentState();
            lastRenderChecksum = ""; 
            syncRegions();
        }
    }

    function findNextValidSong(startIndex) {
        for (var i = startIndex + 1; i < displayList.length; i++) {
            if (!displayList[i].skipped) return displayList[i];
        }
        return null;
    }
    
    function findPrevValidSong(startIndex) {
        for (var i = startIndex - 1; i >= 0; i--) {
            if (!displayList[i].skipped) return displayList[i];
        }
        return null;
    }

    // --- 7. PLAYBACK ---
    function updatePlaybackUI() {
        if (isDragging) return;

        var previousActive = document.querySelector('.region-item.active');
        if (previousActive) previousActive.classList.remove('active');
        
        // Manual loop for querySelectorAll
        var fills = document.querySelectorAll('.progress-fill');
        for(var i=0; i<fills.length; i++) { fills[i].style.width = '0%'; }

        // Find active Index (Polyfill safe)
        var activeIdx = -1;
        for(var j=0; j<displayList.length; j++) {
            var r = displayList[j];
            if (currentPos >= r.start && currentPos <= r.end) {
                activeIdx = j;
                break;
            }
        }
        var activeRegion = (activeIdx !== -1) ? displayList[activeIdx] : null;

        // Reset time display
        if (lastActiveID && (!activeRegion || activeRegion.id !== lastActiveID)) {
            var oldDur = document.getElementById("dur-" + lastActiveID);
            if (oldDur) {
                oldDur.innerText = oldDur.getAttribute("data-length");
                oldDur.classList.remove("live-time");
            }
        }

        if (activeRegion) {
            // Guard: Skipped
            if (activeRegion.skipped) {
                var next = findNextValidSong(activeIdx);
                if (next) {
                    wwr_req("SET/POS/" + next.start);
                    return; 
                }
            }

            var row = document.getElementById("row-" + activeRegion.id);
            if (row) {
                row.classList.add('active');
                if (activeRegion.id !== lastActiveID) {
                    lastActiveID = activeRegion.id;
                    if (document.getElementById('autoScrollToggle').checked) {
                        // Element.scrollIntoView might vary, but basic support exists
                        if(row.scrollIntoView) row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
                var percent = ((currentPos - activeRegion.start) / activeRegion.duration) * 100;
                var bar = document.getElementById("prog-" + activeRegion.id);
                if (bar) bar.style.width = Math.min(100, Math.max(0, percent)) + "%";
                
                // Countdown
                var durEl = document.getElementById("dur-" + activeRegion.id);
                if (durEl) {
                    var remaining = activeRegion.end - currentPos;
                    if (remaining < 0) remaining = 0;
                    durEl.innerText = "-" + formatTime(remaining);
                    durEl.classList.add("live-time");
                }
            }

            var timeRemaining = activeRegion.end - currentPos;
            if (timeRemaining <= 0.2 && timeRemaining > -1 && isPlaying) {
                // Queue
                if (queuedRegion) {
                    wwr_req("SET/POS/" + queuedRegion.start);
                    queuedRegion = null;
                    var queuedEls = document.querySelectorAll('.region-item');
                    for(var k=0; k<queuedEls.length; k++) queuedEls[k].classList.remove('queued');
                    return;
                } 
                
                // Logic
                var shouldPlayNext = false;
                if (activeRegion.chain) shouldPlayNext = true;
                else if (!document.getElementById('autoStopToggle').checked) shouldPlayNext = true;

                if (shouldPlayNext) {
                    var nextRegion = findNextValidSong(activeIdx);
                    if (nextRegion) {
                        wwr_req("SET/POS/" + nextRegion.start);
                        return;
                    }
                }

                if (document.getElementById('autoStopToggle').checked && !activeRegion.chain) {
                    wwr_req(1016); 
                    var nextRegion2 = findNextValidSong(activeIdx);
                    if (nextRegion2) {
                        setTimeout(function() {
                            wwr_req("SET/POS/" + nextRegion2.start);
                        }, 100);
                    }
                }
            }
        }
    }

    function playRegion(start, id) {
        var queueMode = document.getElementById('queueModeToggle').checked;
        if (!isPlaying || !queueMode) {
            wwr_req("SET/POS/" + start);
            wwr_req(1007); // PLAY
            queuedRegion = null;
            var allItems = document.querySelectorAll('.region-item');
            for(var i=0; i<allItems.length; i++) allItems[i].classList.remove('queued');
        } else {
            // Find object for queue
            for(var j=0; j<displayList.length; j++) {
                if (displayList[j].id == id) { queuedRegion = displayList[j]; break; }
            }
            
            var allItems2 = document.querySelectorAll('.region-item');
            for(var k=0; k<allItems2.length; k++) allItems2[k].classList.remove('queued');
            
            var row = document.getElementById("row-" + id);
            if (row) row.classList.add('queued');
        }
    }
    
    function cueRegion(start, id) {
        wwr_req(1016); // STOP
        wwr_req("SET/POS/" + start); 
        flashRow(id);
    }
    
    function smartStop() {
        var activeIdx = -1;
        for(var i=0; i<displayList.length; i++) {
            var r = displayList[i];
            if (currentPos >= r.start && currentPos <= r.end) { activeIdx = i; break; }
        }
        
        var targetPos = null;
        if (activeIdx !== -1) {
            targetPos = displayList[activeIdx].start;
        } else if (displayList.length > 0) {
            targetPos = displayList[0].start; 
        }
        
        wwr_req(1016); // Stop
        
        if (targetPos !== null) {
            setTimeout(function() {
                wwr_req("SET/POS/" + targetPos);
            }, 150);
        }
    }
    
    function togglePlay() {
        if (isPlaying) {
            wwr_req(1008); // PAUSE
        } else {
            var activeIdx = -1;
            for(var i=0; i<displayList.length; i++) {
                var r = displayList[i];
                if (currentPos >= r.start && currentPos <= r.end) { activeIdx = i; break; }
            }
            
            if (activeIdx === -1 && displayList.length > 0) {
                playRegion(displayList[0].start, displayList[0].id);
            } else {
                wwr_req(1007); // PLAY
            }
        }
    }

    // --- 8. FILE IO ---
    function updateSetlistDropdown() {
        var sel = document.getElementById("setlistSelect");
        sel.innerHTML = "";
        for (var name in setlists) {
            if(setlists.hasOwnProperty(name)) {
                var opt = document.createElement("option");
                opt.value = name;
                opt.text = name;
                if (name === currentSetlistName) opt.selected = true;
                sel.appendChild(opt);
            }
        }
    }

    function createSetlist() {
        var name = prompt("Name for new setlist?");
        if (name && !setlists[name]) {
            setlists[name] = displayList.map(function(r){ return { id: r.id, chain: r.chain, skipped: r.skipped }; });
            currentSetlistName = name;
            saveCurrentState();
            updateSetlistDropdown();
            displayList = []; 
            initialized = false;
            syncRegions();
        }
    }

    function deleteSetlist() {
        if (currentSetlistName === "Default") return alert("Cannot delete Default.");
        if (confirm("Delete " + currentSetlistName + "?")) {
            delete setlists[currentSetlistName];
            currentSetlistName = "Default";
            saveCurrentState();
            updateSetlistDropdown();
            displayList = [];
            initialized = false;
            syncRegions();
        }
    }

    function changeSetlist() {
        currentSetlistName = document.getElementById("setlistSelect").value;
        localStorage.setItem(CURRENT_KEY, currentSetlistName);
        displayList = []; 
        initialized = false;
        syncRegions();
    }
    
    function exportSetlists() {
        var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(setlists, null, 2));
        var downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "reaper_setlists.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function triggerImport() {
        document.getElementById('importInput').click();
    }

    function importSetlists(input) {
        var file = input.files[0];
        if (!file) return;
        var reader = new FileReader();
        reader.onload = function(e) {
            try {
                var importedData = JSON.parse(e.target.result);
                if (importedData && typeof importedData === 'object' && importedData["Default"]) {
                    if(confirm("Overwrite all local setlists?")) {
                        setlists = importedData;
                        if (!setlists[currentSetlistName]) currentSetlistName = "Default";
                        saveSetlistsToStorage(); 
                        updateSetlistDropdown();
                        displayList = [];
                        initialized = false;
                        syncRegions();
                        alert("Import Successful!");
                    }
                } else {
                    alert("Invalid File Format.");
                }
            } catch (err) {
                alert("Error reading file.");
            }
        };
        reader.readAsText(file);
        input.value = '';
    }
    
    function saveSetlistsToStorage() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(setlists));
        localStorage.setItem(CURRENT_KEY, currentSetlistName);
    }

    // --- 9. DRAG & DROP ---
    new Sortable(document.getElementById('setlist'), {
        animation: 150,
        handle: '.drag-handle',
        onStart: function (evt) {
            isDragging = true;
        },
        onEnd: function (evt) {
            var items = document.querySelectorAll("#setlist .region-item");
            var newOrder = [];
            var sortedDisplay = [];

            for (var i = 0; i < items.length; i++) {
                var id = items[i].getAttribute("data-id");
                // ES5 find replacement
                var existing = null;
                for(var k=0; k<displayList.length; k++) {
                    if(displayList[k].id == id) { existing = displayList[k]; break; }
                }
                
                if (existing) {
                    newOrder.push({ id: id, chain: existing.chain, skipped: existing.skipped });
                    sortedDisplay.push(existing);
                }
            }

            setlists[currentSetlistName] = newOrder;
            saveCurrentState();
            displayList = sortedDisplay;
            lastRenderChecksum = JSON.stringify(displayList.map(function(r){ 
                return { id: r.id, chain: r.chain, skipped: r.skipped, name: r.name }; 
            }));
            
            setTimeout(function() { isDragging = false; }, 200);
        }
    });

    // --- 10. KEYBOARD CONTROLS ---
    document.addEventListener('keydown', function(event) {
        
        var activeIdx = -1;
        for(var i=0; i<displayList.length; i++) {
            var r = displayList[i];
            if (currentPos >= r.start && currentPos <= r.end) { activeIdx = i; break; }
        }

        // SPACE: Play / Pause
        if (event.code === 'Space') {
            event.preventDefault(); 
            togglePlay();
        }

        // ENTER: Smart Stop
        if (event.code === 'Enter') {
            event.preventDefault();
            smartStop();
        }
        
        // LEFT: Restart
        if (event.code === 'ArrowLeft') {
            event.preventDefault();
            if (activeIdx !== -1) {
                playRegion(displayList[activeIdx].start, displayList[activeIdx].id);
                flashRow(displayList[activeIdx].id);
            }
        }

        // RIGHT: Next (Cue)
        if (event.code === 'ArrowRight') {
            event.preventDefault();
            var targetItem = null;
            if (activeIdx === -1) {
                // Find first valid
                for(var k=0; k<displayList.length; k++) {
                    if(!displayList[k].skipped) { targetItem = displayList[k]; break; }
                }
            } else {
                targetItem = findNextValidSong(activeIdx);
            }

            if (targetItem) {
                cueRegion(targetItem.start, targetItem.id);
            }
        }

        // UP: Prev (Cue)
        if (event.code === 'ArrowUp') {
            event.preventDefault();
            if (activeIdx > 0) {
                var targetItem2 = findPrevValidSong(activeIdx);
                if (targetItem2) cueRegion(targetItem2.start, targetItem2.id);
            }
        }

        // DOWN: Reset
        if (event.code === 'ArrowDown') {
            event.preventDefault();
            if (displayList.length > 0) {
                cueRegion(displayList[0].start, displayList[0].id);
            }
        }
    });

    function flashRow(id) {
        var btn = document.querySelector("#row-" + id + " .load-btn");
        if(btn) {
            btn.style.backgroundColor = "#2196F3";
            btn.style.color = "white";
            setTimeout(function() { btn.style.backgroundColor = ""; btn.style.color = ""; }, 200);
        }
    }

    function showHelp(topic) {
        alert("Help: " + topic);
    }

</script>
</body>
</html>
