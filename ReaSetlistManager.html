<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ReaSetlistManager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="main.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    
    <style>
        /* --- GLOBAL STYLES --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            color: #eee; margin: 0; padding-bottom: 80px; user-select: none;
            min-height: 100vh;
        }

        /* --- CONTROLS AREA --- */
        .controls { 
            position: sticky; top: 0; z-index: 100; 
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            padding: 16px; 
            border-bottom: 2px solid #0f3460;
            display: flex; flex-direction: column; gap: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
        }

        /* Setlist Manager Row */
        .setlist-row { 
            display: flex; gap: 8px; 
            background: rgba(42, 42, 42, 0.6); 
            padding: 10px; 
            border-radius: 12px; 
            align-items: center; 
            border: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
        }
        .setlist-select {
            flex-grow: 1; padding: 10px 12px; 
            background: rgba(17, 17, 17, 0.8);
            color: #fff; 
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px; 
            font-size: 14px; 
            outline: none; 
            min-width: 100px;
            transition: all 0.3s ease;
        }
        .setlist-select:hover {
            border-color: rgba(33, 150, 243, 0.5);
            background: rgba(17, 17, 17, 0.95);
        }
        .btn-mini {
            padding: 10px 14px; 
            font-weight: bold; 
            cursor: pointer; 
            border: 1px solid transparent;
            background: rgba(51, 51, 51, 0.8);
            color: #ccc; 
            border-radius: 8px; 
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .btn-mini:hover { 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        .btn-add { 
            background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%);
            color: white;
            border-color: rgba(76, 175, 80, 0.3);
        }
        .btn-add:hover { 
            box-shadow: 0 4px 16px rgba(76, 175, 80, 0.5);
        }
        .btn-del { 
            background: linear-gradient(135deg, #c62828 0%, #f44336 100%);
            color: white;
            border-color: rgba(244, 67, 54, 0.3);
        }
        .btn-del:hover {
            box-shadow: 0 4px 16px rgba(244, 67, 54, 0.5);
        }
        .btn-exp { 
            background: linear-gradient(135deg, #1565C0 0%, #2196F3 100%);
            color: white;
            border-color: rgba(33, 150, 243, 0.3);
        }
        .btn-exp:hover {
            box-shadow: 0 4px 16px rgba(33, 150, 243, 0.5);
        }
        .btn-imp { 
            background: linear-gradient(135deg, #EF6C00 0%, #FF9800 100%);
            color: white;
            border-color: rgba(255, 152, 0, 0.3);
        }
        .btn-imp:hover {
            box-shadow: 0 4px 16px rgba(255, 152, 0, 0.5);
        }

        /* Transport Row */
        .transport-row { display: flex; gap: 12px; width: 100%; }
        .btn-transport { 
            flex: 1; padding: 16px 0; font-size: 16px; font-weight: bold; 
            cursor: pointer; border-radius: 10px; border: none; color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }
        .btn-transport::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .btn-transport:active::before {
            width: 300px;
            height: 300px;
        }
        .btn-transport:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        .btn-transport:active { transform: scale(0.98); }
        .btn-play { 
            background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
        }
        .btn-play:hover {
            box-shadow: 0 6px 24px rgba(46, 125, 50, 0.5);
        }
        .btn-stop { 
            background: linear-gradient(135deg, #b71c1c 0%, #d32f2f 100%);
        }
        .btn-stop:hover {
            box-shadow: 0 6px 24px rgba(211, 47, 47, 0.5);
        }
        .btn-refresh { 
            background: linear-gradient(135deg, #37474f 0%, #546e7a 100%);
        }
        .btn-refresh:hover {
            box-shadow: 0 6px 24px rgba(84, 110, 122, 0.5);
        }

        /* Toggles Row */
        .toggles-row { 
            display: flex; 
            justify-content: space-around; 
            background: rgba(37, 37, 37, 0.6);
            padding: 12px; 
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .toggle-wrapper { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            font-size: 11px; 
            text-transform: uppercase; 
            color: #aaa;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .help-icon {
            display: inline-flex; justify-content: center; align-items: center;
            width: 18px; height: 18px; border-radius: 50%;
            background: linear-gradient(135deg, #37474f 0%, #546e7a 100%);
            color: #fff; font-weight: bold; font-size: 11px;
            cursor: pointer; margin-left: 2px; 
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .help-icon:hover {
            transform: scale(1.1);
            background: linear-gradient(135deg, #546e7a 0%, #607d8b 100%);
            box-shadow: 0 4px 12px rgba(96, 125, 139, 0.4);
        }

        /* Switches */
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { 
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; 
            background: linear-gradient(135deg, #37474f 0%, #455a64 100%);
            transition: .4s; 
            border-radius: 34px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        .slider:before { 
            position: absolute; content: ""; height: 16px; width: 16px; 
            left: 3px; bottom: 3px; background-color: white; 
            transition: .4s; border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        input:checked + .slider { 
            background: linear-gradient(135deg, #1976D2 0%, #2196F3 100%);
            box-shadow: 0 0 12px rgba(33, 150, 243, 0.4);
        }
        input:checked + .slider:before { 
            transform: translateX(18px);
        }
        .slider:hover {
            opacity: 0.9;
        }

        /* --- SETLIST LIST --- */
        #setlist { 
            list-style: none; padding: 16px; margin: 0; 
            counter-reset: song-counter; 
        }
        .region-item { 
            background: linear-gradient(135deg, rgba(37, 37, 37, 0.8) 0%, rgba(30, 30, 40, 0.8) 100%);
            margin-bottom: 12px; 
            padding: 14px; 
            border-radius: 12px;
            display: flex; 
            align-items: center; 
            gap: 12px; 
            border-left: 4px solid #37474f;
            counter-increment: song-counter; 
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .region-item:hover {
            transform: translateX(4px);
            box-shadow: 0 6px 24px rgba(0,0,0,0.4);
            border-left-color: #546e7a;
        }
        .region-item.active { 
            background: linear-gradient(135deg, rgba(27, 94, 32, 0.3) 0%, rgba(46, 125, 50, 0.2) 100%);
            border-left-color: #00e676;
            box-shadow: 0 6px 24px rgba(0, 230, 118, 0.3);
        }
        .region-item.queued { 
            border-left-color: #ffd54f; 
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.15) 0%, rgba(255, 213, 79, 0.1) 100%);
            animation: pulse 1.5s ease-in-out infinite;
            box-shadow: 0 6px 24px rgba(255, 213, 79, 0.3);
        }
        .region-item.sortable-drag { opacity: 0; }
        
        .region-index {
            font-size: 20px; 
            font-weight: 800; 
            color: #546e7a; 
            min-width: 30px; 
            text-align: center;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .region-index::before { content: counter(song-counter); }

        .drag-handle { 
            font-size: 24px; 
            color: #607d8b; 
            padding: 5px; 
            cursor: grab; 
            line-height: 1;
            transition: all 0.3s ease;
        }
        .drag-handle:hover {
            color: #90caf9;
            transform: scale(1.1);
        }
        .drag-handle:active {
            cursor: grabbing;
        }
        
        .song-info { flex-grow: 1; min-width: 0; }
        .song-header { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: baseline; }
        .song-name { 
            font-weight: 600; 
            color: #fff; 
            font-size: 1.1em;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .song-duration { 
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            color: #90a4ae;
            font-weight: 500;
            font-size: 0.95em;
        }
        
        .progress-bg { 
            background: rgba(17, 17, 17, 0.6);
            height: 6px; 
            width: 100%; 
            border-radius: 10px; 
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        .progress-fill { 
            background: linear-gradient(90deg, #00e676 0%, #00c853 100%);
            height: 100%; 
            width: 0%; 
            transition: width 0.1s linear;
            box-shadow: 0 0 10px rgba(0, 230, 118, 0.5);
        }
        
        .song-actions { display: flex; flex-direction: column; gap: 8px; align-items: flex-end; }
        
        .load-btn { 
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.2) 0%, rgba(33, 150, 243, 0.1) 100%);
            color: #64b5f6; 
            border: 1px solid rgba(33, 150, 243, 0.5);
            border-radius: 8px; 
            padding: 8px 14px; 
            font-size: 12px; 
            font-weight: bold;
            white-space: nowrap; 
            cursor: pointer; 
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .load-btn:hover {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.3) 0%, rgba(33, 150, 243, 0.2) 100%);
            border-color: #2196F3;
            color: #90caf9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }
        .load-btn:active { 
            background: linear-gradient(135deg, #1976D2 0%, #2196F3 100%);
            color: white;
            transform: translateY(0);
        }

        .chain-btn {
            background: rgba(51, 51, 51, 0.6);
            color: #78909c;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px; 
            padding: 6px; 
            width: 100%; 
            text-align: center; 
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .chain-btn:hover {
            background: rgba(69, 69, 69, 0.8);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .chain-btn.linked { 
            background: linear-gradient(135deg, rgba(27, 94, 32, 0.8) 0%, rgba(46, 125, 50, 0.8) 100%);
            color: #a5d6a7;
            border-color: rgba(76, 175, 80, 0.5);
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }
        .chain-btn.linked:hover {
            background: linear-gradient(135deg, rgba(27, 94, 32, 0.9) 0%, rgba(46, 125, 50, 0.9) 100%);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.5);
        }

        @keyframes pulse { 
            0% { opacity: 1; transform: scale(1); } 
            50% { opacity: 0.85; transform: scale(1.005); } 
            100% { opacity: 1; transform: scale(1); } 
        }
    </style>
</head>
<body>

<div class="controls">
    <div class="setlist-row">
        <select id="setlistSelect" class="setlist-select" onchange="changeSetlist()"></select>
        <button class="btn-mini btn-add" onclick="createSetlist()" title="New Setlist">+</button>
        <button class="btn-mini btn-del" onclick="deleteSetlist()" title="Delete Setlist">&#10005;</button>
        <button class="btn-mini btn-exp" onclick="exportSetlists()" title="Download Backup File">&#8595;</button>
        <button class="btn-mini btn-imp" onclick="triggerImport()" title="Upload Backup File">&#8593;</button>
        <input type="file" id="importInput" style="display:none" accept=".json" onchange="importSetlists(this)">
    </div>

    <div class="transport-row">
        <button class="btn-transport btn-play" onclick="wwr_req(1007)">&#9654; PLAY</button>
        <button class="btn-transport btn-stop" onclick="wwr_req(1016)">&#9632; STOP</button>
        <button class="btn-transport btn-refresh" onclick="wwr_start()">&#8635; RESYNC</button>
    </div>

    <div class="toggles-row">
        <div class="toggle-wrapper">
            <label class="switch"><input type="checkbox" id="autoScrollToggle" checked><span class="slider round"></span></label>
            <span>Auto-Scroll</span>
            <span class="help-icon" onclick="showHelp('scroll')">?</span>
        </div>
        <div class="toggle-wrapper">
            <label class="switch"><input type="checkbox" id="queueModeToggle"><span class="slider round"></span></label>
            <span>Queue Mode</span>
            <span class="help-icon" onclick="showHelp('queue')">?</span>
        </div>
        <div class="toggle-wrapper">
            <label class="switch"><input type="checkbox" id="autoStopToggle" checked><span class="slider round"></span></label>
            <span>Auto-Stop</span>
            <span class="help-icon" onclick="showHelp('stop')">?</span>
        </div>
    </div>
</div>

<ul id="setlist"></ul>

<script type="text/javascript">
    // --- 1. REAPER CONNECTION ---
    wwr_req_recur("TRANSPORT", 100);
    wwr_req_recur("REGION", 1000); 
    wwr_start(); 

    // --- 2. STATE ---
    let g_regions = [];      
    let displayList = [];    
    let isPlaying = false;
    let currentPos = 0.0;
    let queuedRegion = null;
    let lastActiveID = null;
    let lastRenderChecksum = "";
    
    // Drag State Flags
    let isDragging = false;
    let initialized = false;

    // STORAGE
    const STORAGE_KEY = "reaper_setlists_v5"; // Version bump
    const CURRENT_KEY = "reaper_current_setlist";

    // LOAD
    let setlists = JSON.parse(localStorage.getItem(STORAGE_KEY)) || { "Default": [] };
    let currentSetlistName = localStorage.getItem(CURRENT_KEY) || "Default";
    
    if (!setlists["Default"]) setlists["Default"] = [];
    if (!setlists[currentSetlistName]) currentSetlistName = "Default";

    updateSetlistDropdown();

    // --- 3. LISTENER ---
    function wwr_onreply(results) {
        if (isDragging) return;

        var ar = results.split("\n");
        for (var x = 0; x < ar.length; x++) {
            var tok = ar[x].split("\t");
            if (tok.length > 0) {
                switch (tok[0]) {
                    case "TRANSPORT":
                        isPlaying = (tok[1] & 1) == 1;
                        currentPos = parseFloat(tok[2]);
                        updatePlaybackUI(); 
                        break;
                    case "REGION_LIST": g_regions = []; break;
                    case "REGION": g_regions.push(tok); break;
                    case "REGION_LIST_END": syncRegions(); break;
                }
            }
        }
    }

    // --- 4. SYNC LOGIC (SCREEN IS AUTHORITY) ---
    function syncRegions() {
        if (isDragging) return;

        // 1. Build Map of Live Reaper Data
        let reaperMap = new Map();
        for (let r of g_regions) {
            if (r.length > 4) {
                reaperMap.set(r[2], { 
                    name: r[1],
                    id: r[2],
                    start: parseFloat(r[3]),
                    end: parseFloat(r[4]),
                    duration: parseFloat(r[4]) - parseFloat(r[3])
                });
            }
        }

        // 2. INITIAL LOAD: If displayList is empty, build it from Storage
        if (displayList.length === 0 && !initialized) {
            let savedList = setlists[currentSetlistName];
            
            // Build initial order from save
            savedList.forEach(item => {
                if (reaperMap.has(item.id)) {
                    let rData = reaperMap.get(item.id);
                    displayList.push({ ...rData, chain: item.chain });
                    reaperMap.delete(item.id);
                }
            });
            
            // Add remaining (new) items
            let newItems = Array.from(reaperMap.values()).sort((a,b) => a.start - b.start);
            newItems.forEach(rData => {
                displayList.push({ ...rData, chain: false });
            });

            // --- AUTO-INIT PLAYHEAD ---
            if (displayList.length > 0) {
                // Move playhead to start of first song on first load
                wwr_req("SET/POS/" + displayList[0].start);
            }
            
            initialized = true;
        } 
        // 3. SUBSEQUENT UPDATES: Update existing DisplayList in place
        else {
            let activeIDs = new Set();
            
            // Update Existing Items
            displayList.forEach(item => {
                if (reaperMap.has(item.id)) {
                    let rData = reaperMap.get(item.id);
                    item.name = rData.name;
                    item.start = rData.start;
                    item.end = rData.end;
                    item.duration = rData.duration;
                    activeIDs.add(item.id);
                    reaperMap.delete(item.id);
                }
            });

            // Filter dead items
            displayList = displayList.filter(item => activeIDs.has(item.id) || reaperMap.has(item.id));

            // Append New Items
            let newItems = Array.from(reaperMap.values()).sort((a,b) => a.start - b.start);
            newItems.forEach(rData => {
                displayList.push({ ...rData, chain: false });
            });
        }

        // 4. Save Logic (Auto-Save current state)
        saveCurrentState();
        
        // 5. Render Check
        let currentChecksum = JSON.stringify(displayList.map(r => ({ id: r.id, chain: r.chain, name: r.name })));
        if (currentChecksum !== lastRenderChecksum) {
            lastRenderChecksum = currentChecksum;
            renderSetlist();
            updatePlaybackUI();
        }
    }

    function saveCurrentState() {
        let storageFormat = displayList.map(r => ({ id: r.id, chain: r.chain }));
        setlists[currentSetlistName] = storageFormat;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(setlists));
        localStorage.setItem(CURRENT_KEY, currentSetlistName);
    }

    // --- 5. RENDER ---
    function formatTime(seconds) {
        let m = Math.floor(seconds / 60);
        let s = Math.round(seconds % 60);
        return `${m}:${s < 10 ? '0' : ''}${s}`;
    }

    function renderSetlist() {
        const listEl = document.getElementById('setlist');
        const scrollPos = listEl.scrollTop;
        listEl.innerHTML = "";
        
        displayList.forEach((r) => {
            let li = document.createElement("li");
            li.className = "region-item";
            li.id = "row-" + r.id;
            li.setAttribute("data-id", r.id);
            li.setAttribute("data-chain", r.chain); 
            
            let chainIcon = r.chain ? "&#10140;" : "&#9632;";
            let chainClass = r.chain ? "chain-btn linked" : "chain-btn";
            let tooltip = r.chain ? "Follow Action: ACTIVE (Plays Next)" : "Follow Action: STOP";
            
            li.innerHTML = `
                <div class="region-index"></div>
                <div class="drag-handle">&#9776;</div>
                <div class="song-info">
                    <div class="song-header">
                        <span class="song-name">${r.name}</span>
                        <span class="song-duration">${formatTime(r.duration)}</span>
                    </div>
                    <div class="progress-bg"><div class="progress-fill" id="prog-${r.id}"></div></div>
                </div>
                <div class="song-actions">
                    <button class="${chainClass}" onclick="toggleChain('${r.id}')" title="${tooltip}">${chainIcon}</button>
                    <button class="load-btn" onclick="playRegion(${r.start}, ${r.id})">PLAY NEXT</button>
                </div>
            `;
            listEl.appendChild(li);
        });
        
        listEl.scrollTop = scrollPos;
    }

    // --- 6. ACTIONS ---
    function toggleChain(id) {
        let item = displayList.find(r => r.id == id);
        if (item) {
            item.chain = !item.chain;
            saveCurrentState();
            lastRenderChecksum = ""; 
            syncRegions();
        }
    }

    // --- 7. PLAYBACK ---
    function updatePlaybackUI() {
        if (isDragging) return;

        let previousActive = document.querySelector('.region-item.active');
        if (previousActive) previousActive.classList.remove('active');
        document.querySelectorAll('.progress-fill').forEach(el => el.style.width = '0%');

        let activeIdx = displayList.findIndex(r => currentPos >= r.start && currentPos <= r.end);
        let activeRegion = displayList[activeIdx];

        if (activeRegion) {
            let row = document.getElementById("row-" + activeRegion.id);
            if (row) {
                row.classList.add('active');
                if (activeRegion.id !== lastActiveID) {
                    lastActiveID = activeRegion.id;
                    if (document.getElementById('autoScrollToggle').checked) {
                        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
                let percent = ((currentPos - activeRegion.start) / activeRegion.duration) * 100;
                let bar = document.getElementById("prog-" + activeRegion.id);
                if (bar) bar.style.width = Math.min(100, Math.max(0, percent)) + "%";
            }

            // Playback Logic
            let timeRemaining = activeRegion.end - currentPos;
            if (timeRemaining <= 0.2 && timeRemaining > -1 && isPlaying) {
                if (queuedRegion) {
                    wwr_req("SET/POS/" + queuedRegion.start);
                    queuedRegion = null;
                    document.querySelectorAll('.region-item').forEach(el => el.classList.remove('queued'));
                    return;
                } 
                if (activeRegion.chain) {
                    let nextRegion = displayList[activeIdx + 1];
                    if (nextRegion) {
                        wwr_req("SET/POS/" + nextRegion.start);
                        return;
                    }
                }
                if (document.getElementById('autoStopToggle').checked) {
                    wwr_req(1016); 
                }
            }
        }
    }

    function playRegion(start, id) {
        const queueMode = document.getElementById('queueModeToggle').checked;
        if (!isPlaying || !queueMode) {
            wwr_req("SET/POS/" + start);
            wwr_req(1007); 
            queuedRegion = null;
            document.querySelectorAll('.region-item').forEach(el => el.classList.remove('queued'));
        } else {
            queuedRegion = displayList.find(r => r.id == id);
            document.querySelectorAll('.region-item').forEach(el => el.classList.remove('queued'));
            let row = document.getElementById("row-" + id);
            if (row) row.classList.add('queued');
        }
    }

    // --- 8. FILE IO ---
    function updateSetlistDropdown() {
        const sel = document.getElementById("setlistSelect");
        sel.innerHTML = "";
        Object.keys(setlists).forEach(name => {
            let opt = document.createElement("option");
            opt.value = name;
            opt.text = name;
            if (name === currentSetlistName) opt.selected = true;
            sel.appendChild(opt);
        });
    }

    function createSetlist() {
        let name = prompt("Name for new setlist?");
        if (name && !setlists[name]) {
            setlists[name] = displayList.map(r => ({ id: r.id, chain: r.chain }));
            currentSetlistName = name;
            saveCurrentState();
            updateSetlistDropdown();
            // Force re-init on setlist change
            displayList = []; 
            initialized = false;
            syncRegions();
        }
    }

    function deleteSetlist() {
        if (currentSetlistName === "Default") return alert("Cannot delete Default.");
        if (confirm("Delete " + currentSetlistName + "?")) {
            delete setlists[currentSetlistName];
            currentSetlistName = "Default";
            saveCurrentState();
            updateSetlistDropdown();
            displayList = [];
            initialized = false;
            syncRegions();
        }
    }

    function changeSetlist() {
        currentSetlistName = document.getElementById("setlistSelect").value;
        localStorage.setItem(CURRENT_KEY, currentSetlistName);
        displayList = []; // Clear display to force rebuild from new setlist
        initialized = false;
        syncRegions();
    }
    
    function exportSetlists() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(setlists, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "reaper_setlists.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function triggerImport() {
        document.getElementById('importInput').click();
    }

    function importSetlists(input) {
        let file = input.files[0];
        if (!file) return;
        let reader = new FileReader();
        reader.onload = function(e) {
            try {
                let importedData = JSON.parse(e.target.result);
                if (importedData && typeof importedData === 'object' && importedData["Default"]) {
                    if(confirm("Overwrite all local setlists with this file?")) {
                        setlists = importedData;
                        if (!setlists[currentSetlistName]) currentSetlistName = "Default";
                        saveSetlistsToStorage(); 
                        updateSetlistDropdown();
                        // Reset View
                        displayList = [];
                        initialized = false;
                        syncRegions();
                        alert("Import Successful!");
                    }
                } else {
                    alert("Invalid File Format.");
                }
            } catch (err) {
                alert("Error reading file.");
            }
        };
        reader.readAsText(file);
        input.value = '';
    }
    
    function saveSetlistsToStorage() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(setlists));
        localStorage.setItem(CURRENT_KEY, currentSetlistName);
    }

    // --- 9. DRAG & DROP (Visual Master) ---
    new Sortable(document.getElementById('setlist'), {
        animation: 150,
        handle: '.drag-handle',
        onStart: function (evt) {
            isDragging = true;
        },
        onEnd: function (evt) {
            // 1. Scrape DOM
            let items = document.querySelectorAll("#setlist .region-item");
            let newOrder = [];
            let sortedDisplay = [];

            items.forEach(el => {
                let id = el.getAttribute("data-id");
                // Find existing data to keep properties intact
                let existing = displayList.find(r => r.id == id);
                if (existing) {
                    newOrder.push({ id: id, chain: existing.chain });
                    sortedDisplay.push(existing);
                }
            });

            // 2. Commit Order to Storage
            setlists[currentSetlistName] = newOrder;
            saveCurrentState();
            
            // 3. Update Visual Authority (Internal Array)
            displayList = sortedDisplay;
            
            // 4. Update Checksum
            lastRenderChecksum = JSON.stringify(displayList.map(r => ({ id: r.id, chain: r.chain, name: r.name })));
            
            // 5. Resume (Short delay to clear events)
            setTimeout(() => { isDragging = false; }, 200);
        }
    });

    // --- 10. KEYBOARD CONTROLS (CUSTOM MAP) ---
    document.addEventListener('keydown', function(event) {
        
        let activeIdx = displayList.findIndex(r => currentPos >= r.start && currentPos <= r.end);

        // SPACE: Toggle Play/Pause (Smart Start)
        if (event.code === 'Space') {
            event.preventDefault(); 
            if (isPlaying) {
                wwr_req(1008); // Pause
            } else {
                if (activeIdx === -1 && displayList.length > 0) {
                    playRegion(displayList[0].start, displayList[0].id);
                } else {
                    wwr_req(1007); // Play
                }
            }
        }

        // ENTER: PANIC STOP
        if (event.code === 'Enter') {
            event.preventDefault();
            wwr_req(1016); // Stop Immediately
            // Move playhead to start of current song
            if (activeIdx !== -1) {
                wwr_req("SET/POS/" + displayList[activeIdx].start);
            }
        }
        
        // LEFT ARROW: RESTART CURRENT
        if (event.code === 'ArrowLeft') {
            event.preventDefault();
            if (activeIdx !== -1) {
                // If active, restart
                playRegion(displayList[activeIdx].start, displayList[activeIdx].id);
                flashRow(displayList[activeIdx].id);
            }
        }

        // RIGHT ARROW: NEXT SONG
        if (event.code === 'ArrowRight') {
            event.preventDefault();
            let targetItem;
            if (activeIdx === -1) targetItem = displayList[0];
            else if (activeIdx + 1 < displayList.length) targetItem = displayList[activeIdx + 1];

            if (targetItem) {
                playRegion(targetItem.start, targetItem.id);
                flashRow(targetItem.id);
            }
        }

        // UP ARROW: PREVIOUS SONG
        if (event.code === 'ArrowUp') {
            event.preventDefault();
            if (activeIdx > 0) {
                let targetItem = displayList[activeIdx - 1];
                playRegion(targetItem.start, targetItem.id);
                flashRow(targetItem.id);
            }
        }

        // DOWN ARROW: START OF SET (Song 1)
        if (event.code === 'ArrowDown') {
            event.preventDefault();
            if (displayList.length > 0) {
                playRegion(displayList[0].start, displayList[0].id);
                flashRow(displayList[0].id);
            }
        }
    });

    // Helper for key feedback
    function flashRow(id) {
        let btn = document.querySelector(`#row-${id} .load-btn`);
        if(btn) {
            btn.style.backgroundColor = "#2196F3";
            btn.style.color = "white";
            setTimeout(() => { btn.style.backgroundColor = ""; btn.style.color = ""; }, 200);
        }
    }

    function showHelp(topic) {
        const msgs = {
            scroll: "Auto-Scroll keeps the playing song visible.",
            queue: "Queue Mode ON = seamless transition.\nQueue Mode OFF = instant jump.",
            stop: "Auto-Stop ON = stops at end of region.\n(Use the chain button to override per song)."
        };
        alert(msgs[topic]);
    }

</script>
</body>
</html>
