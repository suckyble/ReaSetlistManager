<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ReaSetlistManager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="main.js"></script>
    <script src="Sortable.min.js"></script>
    
    <style>
        /* --- GLOBAL & THEME --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            color: #eee; margin: 0; padding-bottom: 80px; user-select: none;
            min-height: 100vh;
        }

        /* --- CONTROLS AREA --- */
        .controls { 
            position: sticky; top: 0; z-index: 100; 
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            padding: 16px; 
            border-bottom: 2px solid #0f3460;
            display: flex; flex-direction: column; gap: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
        }

        /* Setlist Manager Row */
        .setlist-row { 
            display: flex; gap: 8px; 
            background: rgba(42, 42, 42, 0.6); 
            padding: 10px; 
            border-radius: 12px; 
            align-items: center; 
            border: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
        }
        .setlist-select {
            flex-grow: 1; padding: 10px 12px; 
            background: rgba(17, 17, 17, 0.8);
            color: #fff; 
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px; 
            font-size: 14px; 
            outline: none; 
            min-width: 100px;
            transition: all 0.3s ease;
        }
        .setlist-select:hover {
            border-color: rgba(33, 150, 243, 0.5);
            background: rgba(17, 17, 17, 0.95);
        }
        .btn-mini {
            padding: 10px 14px; 
            font-weight: bold; 
            cursor: pointer; 
            border: 1px solid transparent;
            background: rgba(51, 51, 51, 0.8);
            color: #ccc; 
            border-radius: 8px; 
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .btn-mini:hover { 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        .btn-add { background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%); color: white; border-color: rgba(76, 175, 80, 0.3); }
        .btn-del { background: linear-gradient(135deg, #c62828 0%, #f44336 100%); color: white; border-color: rgba(244, 67, 54, 0.3); }
        .btn-exp { background: linear-gradient(135deg, #1565C0 0%, #2196F3 100%); color: white; border-color: rgba(33, 150, 243, 0.3); }
        .btn-imp { background: linear-gradient(135deg, #EF6C00 0%, #FF9800 100%); color: white; border-color: rgba(255, 152, 0, 0.3); }

        /* Transport Row */
        .transport-row { display: flex; gap: 12px; width: 100%; }
        .btn-transport { 
            flex: 1; padding: 16px 0; font-size: 16px; font-weight: bold; 
            cursor: pointer; border-radius: 10px; border: none; color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }
        .btn-transport:active { transform: scale(0.98); }
        .btn-play { background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%); }
        .btn-stop { background: linear-gradient(135deg, #b71c1c 0%, #d32f2f 100%); }
        .btn-refresh { background: linear-gradient(135deg, #37474f 0%, #546e7a 100%); }

        /* Toggles Row */
        .toggles-row { 
            display: flex; justify-content: space-around; 
            background: rgba(37, 37, 37, 0.6);
            padding: 12px; border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .toggle-wrapper { 
            display: flex; align-items: center; gap: 10px; 
            font-size: 11px; text-transform: uppercase; color: #aaa;
            font-weight: 600; letter-spacing: 0.5px;
        }
        .help-icon {
            display: inline-flex; justify-content: center; align-items: center;
            width: 18px; height: 18px; border-radius: 50%;
            background: linear-gradient(135deg, #37474f 0%, #546e7a 100%);
            color: #fff; font-weight: bold; font-size: 11px;
            cursor: pointer; margin-left: 2px; 
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Switches */
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { 
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; 
            background: linear-gradient(135deg, #37474f 0%, #455a64 100%);
            transition: .4s; border-radius: 34px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        .slider:before { 
            position: absolute; content: ""; height: 16px; width: 16px; 
            left: 3px; bottom: 3px; background-color: white; 
            transition: .4s; border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        input:checked + .slider { background: linear-gradient(135deg, #1976D2 0%, #2196F3 100%); }
        input:checked + .slider:before { transform: translateX(18px); }

        /* --- SETLIST LIST --- */
        #setlist { 
            list-style: none; padding: 16px; margin: 0; 
            counter-reset: song-counter; 
        }
        .region-item { 
            background: linear-gradient(135deg, rgba(37, 37, 37, 0.8) 0%, rgba(30, 30, 40, 0.8) 100%);
            margin-bottom: 12px; padding: 14px; border-radius: 12px;
            display: flex; align-items: center; gap: 12px; 
            border-left: 4px solid #37474f;
            counter-increment: song-counter; 
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .region-item:hover {
            transform: translateX(4px);
            box-shadow: 0 6px 24px rgba(0,0,0,0.4);
            border-left-color: #546e7a;
        }
        .region-item.active { 
            background: linear-gradient(135deg, rgba(27, 94, 32, 0.3) 0%, rgba(46, 125, 50, 0.2) 100%);
            border-left-color: #00e676;
            box-shadow: 0 6px 24px rgba(0, 230, 118, 0.3);
        }
        .region-item.queued { 
            border-left-color: #ffd54f; 
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.15) 0%, rgba(255, 213, 79, 0.1) 100%);
            animation: pulse 1.5s ease-in-out infinite;
            box-shadow: 0 6px 24px rgba(255, 213, 79, 0.3);
        }
        
        .region-item.skipped {
            opacity: 0.4;
            border-left-color: #444;
            background: #1a1a1a;
            filter: grayscale(100%);
        }
        .region-item.sortable-drag { opacity: 0; }
        
        .region-index {
            font-size: 20px; font-weight: 800; color: #546e7a; 
            min-width: 30px; text-align: center;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .region-index::before { content: counter(song-counter); }

        .drag-handle { 
            font-size: 24px; color: #607d8b; padding: 5px; 
            cursor: grab; line-height: 1; transition: all 0.3s ease;
        }
        .drag-handle:hover { color: #90caf9; transform: scale(1.1); }
        .drag-handle:active { cursor: grabbing; }
        
        .song-info { flex-grow: 1; min-width: 0; }
        .song-header { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: baseline; }
        .song-name { 
            font-weight: 600; color: #fff; font-size: 1.1em;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .song-duration { 
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            color: #90a4ae; font-weight: 500; font-size: 0.95em;
            min-width: 50px; text-align: right;
        }
        /* Active countdown style */
        .song-duration.live-time {
            color: #00e676; 
            font-weight: 800;
            text-shadow: 0 0 10px rgba(0, 230, 118, 0.4);
        }
        
        .progress-bg { 
            background: rgba(17, 17, 17, 0.6);
            height: 6px; width: 100%; border-radius: 10px; 
            overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        .progress-fill { 
            background: linear-gradient(90deg, #00e676 0%, #00c853 100%);
            height: 100%; width: 0%; transition: width 0.1s linear;
            box-shadow: 0 0 10px rgba(0, 230, 118, 0.5);
        }
        
        .song-actions { display: flex; flex-direction: column; gap: 8px; align-items: flex-end; }
        .btn-row-group { display: flex; gap: 6px; width: 100%; }

        .load-btn { 
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.2) 0%, rgba(33, 150, 243, 0.1) 100%);
            color: #64b5f6; border: 1px solid rgba(33, 150, 243, 0.5);
            border-radius: 8px; padding: 8px 14px; font-size: 12px; font-weight: bold;
            white-space: nowrap; cursor: pointer; width: 100%;
            transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .load-btn:hover {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.3) 0%, rgba(33, 150, 243, 0.2) 100%);
            border-color: #2196F3; color: #90caf9; transform: translateY(-2px);
        }
        .load-btn:active { 
            background: linear-gradient(135deg, #1976D2 0%, #2196F3 100%);
            color: white; transform: translateY(0);
        }

        .chain-btn {
            background: rgba(51, 51, 51, 0.6); color: #78909c;
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; 
            padding: 6px; width: 50%; text-align: center; cursor: pointer;
            transition: all 0.3s ease; font-weight: bold;
        }
        .chain-btn:hover { background: rgba(69, 69, 69, 0.8); transform: translateY(-2px); }
        .chain-btn.linked { 
            background: linear-gradient(135deg, rgba(27, 94, 32, 0.8) 0%, rgba(46, 125, 50, 0.8) 100%);
            color: #a5d6a7; border-color: rgba(76, 175, 80, 0.5);
        }
        /* Hide chain on last item */
        #setlist .region-item:last-child .chain-btn { visibility: hidden; pointer-events: none; }

        .skip-btn {
            background: rgba(51, 51, 51, 0.6); color: #78909c;
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; 
            padding: 6px; width: 50%; text-align: center; cursor: pointer;
            transition: all 0.3s ease; font-weight: bold;
        }
        .skip-btn:hover { background: rgba(69, 69, 69, 0.8); transform: translateY(-2px); }
        .skip-btn.skipped { 
            background: linear-gradient(135deg, rgba(183, 28, 28, 0.8) 0%, rgba(211, 47, 47, 0.8) 100%);
            color: #ef9a9a; border-color: rgba(244, 67, 54, 0.5);
        }

        @keyframes pulse { 
            0% { opacity: 1; transform: scale(1); } 
            50% { opacity: 0.85; transform: scale(1.005); } 
            100% { opacity: 1; transform: scale(1); } 
        }
    </style>
</head>
<body>

<div class="controls">
    <div class="setlist-row">
        <select id="setlistSelect" class="setlist-select" onchange="changeSetlist()"></select>
        <button class="btn-mini btn-add" onclick="createSetlist()" title="New Setlist">+</button>
        <button class="btn-mini btn-del" onclick="deleteSetlist()" title="Delete Setlist">&#10005;</button>
        <button class="btn-mini btn-exp" onclick="exportSetlists()" title="Download Backup File">&#8595;</button>
        <button class="btn-mini btn-imp" onclick="triggerImport()" title="Upload Backup File">&#8593;</button>
        <input type="file" id="importInput" style="display:none" accept=".json" onchange="importSetlists(this)">
    </div>

    <div class="transport-row">
        <button class="btn-transport btn-play" onclick="togglePlay()">&#9654; PLAY</button>
        <button class="btn-transport btn-stop" onclick="smartStop()">&#9632; STOP</button>
        <button class="btn-transport btn-refresh" onclick="wwr_start()">&#8635; RESYNC</button>
    </div>

    <div class="toggles-row">
        <div class="toggle-wrapper">
            <label class="switch"><input type="checkbox" id="autoScrollToggle" checked><span class="slider round"></span></label>
            <span>Auto-Scroll</span>
            <span class="help-icon" onclick="showHelp('scroll')">?</span>
        </div>
        <div class="toggle-wrapper">
            <label class="switch"><input type="checkbox" id="queueModeToggle"><span class="slider round"></span></label>
            <span>Queue Mode</span>
            <span class="help-icon" onclick="showHelp('queue')">?</span>
        </div>
        <div class="toggle-wrapper">
            <label class="switch"><input type="checkbox" id="autoStopToggle" checked><span class="slider round"></span></label>
            <span>Auto-Stop</span>
            <span class="help-icon" onclick="showHelp('stop')">?</span>
        </div>
    </div>
</div>

<ul id="setlist"></ul>

<script type="text/javascript">
    // --- 1. REAPER CONNECTION ---
    wwr_req_recur("TRANSPORT", 100);
    wwr_req_recur("REGION", 1000); 
    wwr_start(); 

    // --- 2. STATE ---
    let g_regions = [];      
    let displayList = [];    
    let isPlaying = false;
    let currentPos = 0.0;
    let queuedRegion = null;
    let lastActiveID = null;
    let lastRenderChecksum = "";
    let isDragging = false;
    let initialized = false;

    // STORAGE - Version 9
    const STORAGE_KEY = "reaper_setlists_v9"; 
    const CURRENT_KEY = "reaper_current_setlist";

    // LOAD
    let setlists = JSON.parse(localStorage.getItem(STORAGE_KEY)) || { "Default": [] };
    let currentSetlistName = localStorage.getItem(CURRENT_KEY) || "Default";
    
    if (!setlists["Default"]) setlists["Default"] = [];
    if (!setlists[currentSetlistName]) currentSetlistName = "Default";

    updateSetlistDropdown();

    // --- 3. LISTENER ---
    function wwr_onreply(results) {
        if (isDragging) return;

        var ar = results.split("\n");
        for (var x = 0; x < ar.length; x++) {
            var tok = ar[x].split("\t");
            if (tok.length > 0) {
                switch (tok[0]) {
                    case "TRANSPORT":
                        isPlaying = (tok[1] & 1) == 1;
                        currentPos = parseFloat(tok[2]);
                        updatePlaybackUI(); 
                        break;
                    case "REGION_LIST": g_regions = []; break;
                    case "REGION": g_regions.push(tok); break;
                    case "REGION_LIST_END": syncRegions(); break;
                }
            }
        }
    }

    // --- 4. SYNC LOGIC ---
    function syncRegions() {
        if (isDragging) return;

        let reaperMap = new Map();
        for (let r of g_regions) {
            if (r.length > 4) {
                reaperMap.set(r[2], { 
                    name: r[1],
                    id: r[2],
                    start: parseFloat(r[3]),
                    end: parseFloat(r[4]),
                    duration: parseFloat(r[4]) - parseFloat(r[3])
                });
            }
        }

        if (displayList.length === 0 && !initialized) {
            let savedList = setlists[currentSetlistName];
            savedList.forEach(item => {
                if (reaperMap.has(item.id)) {
                    let rData = reaperMap.get(item.id);
                    displayList.push({ ...rData, chain: item.chain, skipped: item.skipped === true });
                    reaperMap.delete(item.id);
                }
            });
            let newItems = Array.from(reaperMap.values()).sort((a,b) => a.start - b.start);
            newItems.forEach(rData => {
                displayList.push({ ...rData, chain: false, skipped: false });
            });
            
            if (displayList.length > 0) {
                wwr_req("SET/POS/" + displayList[0].start);
            }
            initialized = true;
        } 
        else {
            let activeIDs = new Set();
            displayList.forEach(item => {
                if (reaperMap.has(item.id)) {
                    let rData = reaperMap.get(item.id);
                    item.name = rData.name;
                    item.start = rData.start;
                    item.end = rData.end;
                    item.duration = rData.duration;
                    activeIDs.add(item.id);
                    reaperMap.delete(item.id);
                }
            });
            displayList = displayList.filter(item => activeIDs.has(item.id) || reaperMap.has(item.id));
            let newItems = Array.from(reaperMap.values()).sort((a,b) => a.start - b.start);
            newItems.forEach(rData => {
                displayList.push({ ...rData, chain: false, skipped: false });
            });
        }

        saveCurrentState();
        
        let currentChecksum = JSON.stringify(displayList.map(r => ({ id: r.id, chain: r.chain, skipped: r.skipped, name: r.name })));
        if (currentChecksum !== lastRenderChecksum) {
            lastRenderChecksum = currentChecksum;
            renderSetlist();
            updatePlaybackUI();
        }
    }

    function saveCurrentState() {
        let storageFormat = displayList.map(r => ({ id: r.id, chain: r.chain, skipped: r.skipped }));
        setlists[currentSetlistName] = storageFormat;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(setlists));
        localStorage.setItem(CURRENT_KEY, currentSetlistName);
    }

    // --- 5. RENDER ---
    function formatTime(seconds) {
        let m = Math.floor(seconds / 60);
        let s = Math.round(seconds % 60);
        return `${m}:${s < 10 ? '0' : ''}${s}`;
    }

    function renderSetlist() {
        const listEl = document.getElementById('setlist');
        const scrollPos = listEl.scrollTop;
        listEl.innerHTML = "";
        
        displayList.forEach((r, index) => {
            let li = document.createElement("li");
            li.className = "region-item" + (r.skipped ? " skipped" : "");
            li.id = "row-" + r.id;
            li.setAttribute("data-id", r.id);
            li.setAttribute("data-chain", r.chain); 
            li.setAttribute("data-skipped", r.skipped);
            
            let chainIcon = r.chain ? "&#10140;" : "&#9632;";
            let chainClass = r.chain ? "chain-btn linked" : "chain-btn";
            
            let skipIcon = r.skipped ? "&#10004;" : "&#10006;";
            let skipClass = r.skipped ? "skip-btn skipped" : "skip-btn";
            
            // Add ID for duration element targetting
            li.innerHTML = `
                <div class="region-index"></div>
                <div class="drag-handle">&#9776;</div>
                <div class="song-info">
                    <div class="song-header">
                        <span class="song-name">${r.name}</span>
                        <span class="song-duration" id="dur-${r.id}" data-length="${formatTime(r.duration)}">${formatTime(r.duration)}</span>
                    </div>
                    <div class="progress-bg"><div class="progress-fill" id="prog-${r.id}"></div></div>
                </div>
                <div class="song-actions">
                    <div class="btn-row-group">
                        <button class="${chainClass}" onclick="toggleChain('${r.id}')" title="Follow Action">${chainIcon}</button>
                        <button class="${skipClass}" onclick="toggleSkip('${r.id}')" title="Skip Song">${skipIcon}</button>
                    </div>
                    <button class="load-btn" onclick="playRegion(${r.start}, ${r.id})">PLAY NEXT</button>
                </div>
            `;
            listEl.appendChild(li);
        });
        
        listEl.scrollTop = scrollPos;
    }

    // --- 6. ACTIONS ---
    function toggleChain(id) {
        let item = displayList.find(r => r.id == id);
        if (item) {
            item.chain = !item.chain;
            saveCurrentState();
            lastRenderChecksum = ""; 
            syncRegions();
        }
    }

    function toggleSkip(id) {
        let item = displayList.find(r => r.id == id);
        if (item) {
            item.skipped = !item.skipped;
            saveCurrentState();
            lastRenderChecksum = ""; 
            syncRegions();
        }
    }

    function findNextValidSong(startIndex) {
        for (let i = startIndex + 1; i < displayList.length; i++) {
            if (!displayList[i].skipped) return displayList[i];
        }
        return null;
    }
    
    function findPrevValidSong(startIndex) {
        for (let i = startIndex - 1; i >= 0; i--) {
            if (!displayList[i].skipped) return displayList[i];
        }
        return null;
    }

    // --- 7. PLAYBACK ---
    function updatePlaybackUI() {
        if (isDragging) return;

        let previousActive = document.querySelector('.region-item.active');
        if (previousActive) previousActive.classList.remove('active');
        document.querySelectorAll('.progress-fill').forEach(el => el.style.width = '0%');

        let activeIdx = displayList.findIndex(r => currentPos >= r.start && currentPos <= r.end);
        let activeRegion = displayList[activeIdx];

        // Reset time display
        if (lastActiveID && (!activeRegion || activeRegion.id !== lastActiveID)) {
            let oldDur = document.getElementById("dur-" + lastActiveID);
            if (oldDur) {
                oldDur.innerText = oldDur.getAttribute("data-length");
                oldDur.classList.remove("live-time");
            }
        }

        if (activeRegion) {
            if (activeRegion.skipped) {
                let next = findNextValidSong(activeIdx);
                if (next) {
                    wwr_req("SET/POS/" + next.start);
                    return; 
                }
            }

            let row = document.getElementById("row-" + activeRegion.id);
            if (row) {
                row.classList.add('active');
                if (activeRegion.id !== lastActiveID) {
                    lastActiveID = activeRegion.id;
                    if (document.getElementById('autoScrollToggle').checked) {
                        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
                let percent = ((currentPos - activeRegion.start) / activeRegion.duration) * 100;
                let bar = document.getElementById("prog-" + activeRegion.id);
                if (bar) bar.style.width = Math.min(100, Math.max(0, percent)) + "%";
                
                // Countdown
                let durEl = document.getElementById("dur-" + activeRegion.id);
                if (durEl) {
                    let remaining = activeRegion.end - currentPos;
                    if (remaining < 0) remaining = 0;
                    durEl.innerText = "-" + formatTime(remaining);
                    durEl.classList.add("live-time");
                }
            }

            let timeRemaining = activeRegion.end - currentPos;
            if (timeRemaining <= 0.2 && timeRemaining > -1 && isPlaying) {
                if (queuedRegion) {
                    wwr_req("SET/POS/" + queuedRegion.start);
                    queuedRegion = null;
                    document.querySelectorAll('.region-item').forEach(el => el.classList.remove('queued'));
                    return;
                } 
                
                let shouldPlayNext = false;
                if (activeRegion.chain) shouldPlayNext = true;
                else if (!document.getElementById('autoStopToggle').checked) shouldPlayNext = true;

                if (shouldPlayNext) {
                    let nextRegion = findNextValidSong(activeIdx);
                    if (nextRegion) {
                        wwr_req("SET/POS/" + nextRegion.start);
                        return;
                    }
                }

                if (document.getElementById('autoStopToggle').checked && !activeRegion.chain) {
                    wwr_req(1016); 
                    let nextRegion = findNextValidSong(activeIdx);
                    if (nextRegion) {
                        setTimeout(() => {
                            wwr_req("SET/POS/" + nextRegion.start);
                        }, 100);
                    }
                }
            }
        }
    }

    function playRegion(start, id) {
        const queueMode = document.getElementById('queueModeToggle').checked;
        if (!isPlaying || !queueMode) {
            wwr_req("SET/POS/" + start);
            wwr_req(1007); // FORCE PLAY
            queuedRegion = null;
            document.querySelectorAll('.region-item').forEach(el => el.classList.remove('queued'));
        } else {
            queuedRegion = displayList.find(r => r.id == id);
            document.querySelectorAll('.region-item').forEach(el => el.classList.remove('queued'));
            let row = document.getElementById("row-" + id);
            if (row) row.classList.add('queued');
        }
    }
    
    function cueRegion(start, id) {
        wwr_req(1016); // STOP
        wwr_req("SET/POS/" + start); // Jump
        flashRow(id);
    }
    
    function smartStop() {
        let activeIdx = displayList.findIndex(r => currentPos >= r.start && currentPos <= r.end);
        let targetPos = null;
        
        if (activeIdx !== -1) {
            targetPos = displayList[activeIdx].start;
        } else if (displayList.length > 0) {
            targetPos = displayList[0].start; 
        }
        
        wwr_req(1016); // Stop
        
        if (targetPos !== null) {
            setTimeout(() => {
                wwr_req("SET/POS/" + targetPos);
            }, 150);
        }
    }
    
    // NEW: Unified Play/Pause toggle for GUI and Spacebar
    function togglePlay() {
        if (isPlaying) {
            wwr_req(1008); // PAUSE
        } else {
            // Smart Start Logic
            let activeIdx = displayList.findIndex(r => currentPos >= r.start && currentPos <= r.end);
            
            if (activeIdx === -1 && displayList.length > 0) {
                // Not playing a song? Start from #1
                playRegion(displayList[0].start, displayList[0].id);
            } else {
                // Else, resume normally
                wwr_req(1007); // PLAY
            }
        }
    }

    // --- 8. FILE IO ---
    function updateSetlistDropdown() {
        const sel = document.getElementById("setlistSelect");
        sel.innerHTML = "";
        Object.keys(setlists).forEach(name => {
            let opt = document.createElement("option");
            opt.value = name;
            opt.text = name;
            if (name === currentSetlistName) opt.selected = true;
            sel.appendChild(opt);
        });
    }

    function createSetlist() {
        let name = prompt("Name for new setlist?");
        if (name && !setlists[name]) {
            setlists[name] = displayList.map(r => ({ id: r.id, chain: r.chain, skipped: r.skipped }));
            currentSetlistName = name;
            saveCurrentState();
            updateSetlistDropdown();
            displayList = []; 
            initialized = false;
            syncRegions();
        }
    }

    function deleteSetlist() {
        if (currentSetlistName === "Default") return alert("Cannot delete Default.");
        if (confirm("Delete " + currentSetlistName + "?")) {
            delete setlists[currentSetlistName];
            currentSetlistName = "Default";
            saveCurrentState();
            updateSetlistDropdown();
            displayList = [];
            initialized = false;
            syncRegions();
        }
    }

    function changeSetlist() {
        currentSetlistName = document.getElementById("setlistSelect").value;
        localStorage.setItem(CURRENT_KEY, currentSetlistName);
        displayList = []; 
        initialized = false;
        syncRegions();
    }
    
    function exportSetlists() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(setlists, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "reaper_setlists.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function triggerImport() {
        document.getElementById('importInput').click();
    }

    function importSetlists(input) {
        let file = input.files[0];
        if (!file) return;
        let reader = new FileReader();
        reader.onload = function(e) {
            try {
                let importedData = JSON.parse(e.target.result);
                if (importedData && typeof importedData === 'object' && importedData["Default"]) {
                    if(confirm("Overwrite all local setlists?")) {
                        setlists = importedData;
                        if (!setlists[currentSetlistName]) currentSetlistName = "Default";
                        saveSetlistsToStorage(); 
                        updateSetlistDropdown();
                        displayList = [];
                        initialized = false;
                        syncRegions();
                        alert("Import Successful!");
                    }
                } else {
                    alert("Invalid File Format.");
                }
            } catch (err) {
                alert("Error reading file.");
            }
        };
        reader.readAsText(file);
        input.value = '';
    }
    
    function saveSetlistsToStorage() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(setlists));
        localStorage.setItem(CURRENT_KEY, currentSetlistName);
    }

    // --- 9. DRAG & DROP ---
    new Sortable(document.getElementById('setlist'), {
        animation: 150,
        handle: '.drag-handle',
        onStart: function (evt) {
            isDragging = true;
        },
        onEnd: function (evt) {
            let items = document.querySelectorAll("#setlist .region-item");
            let newOrder = [];
            let sortedDisplay = [];

            items.forEach(el => {
                let id = el.getAttribute("data-id");
                let existing = displayList.find(r => r.id == id);
                if (existing) {
                    newOrder.push({ id: id, chain: existing.chain, skipped: existing.skipped });
                    sortedDisplay.push(existing);
                }
            });

            setlists[currentSetlistName] = newOrder;
            saveCurrentState();
            displayList = sortedDisplay;
            lastRenderChecksum = JSON.stringify(displayList.map(r => ({ id: r.id, chain: r.chain, skipped: r.skipped, name: r.name })));
            
            setTimeout(() => { isDragging = false; }, 200);
        }
    });

    // --- 10. KEYBOARD CONTROLS ---
    document.addEventListener('keydown', function(event) {
        
        let activeIdx = displayList.findIndex(r => currentPos >= r.start && currentPos <= r.end);

        // SPACE: Toggle Play/Pause via helper
        if (event.code === 'Space') {
            event.preventDefault(); 
            togglePlay();
        }

        // ENTER: Smart Stop
        if (event.code === 'Enter') {
            event.preventDefault();
            smartStop();
        }
        
        // LEFT: Restart
        if (event.code === 'ArrowLeft') {
            event.preventDefault();
            if (activeIdx !== -1) {
                playRegion(displayList[activeIdx].start, displayList[activeIdx].id);
                flashRow(displayList[activeIdx].id);
            }
        }

        // RIGHT: Next (Cue)
        if (event.code === 'ArrowRight') {
            event.preventDefault();
            let targetItem;
            if (activeIdx === -1) {
                targetItem = displayList[0];
            } else {
                targetItem = findNextValidSong(activeIdx);
            }

            if (targetItem) {
                cueRegion(targetItem.start, targetItem.id);
            }
        }

        // UP: Prev (Cue)
        if (event.code === 'ArrowUp') {
            event.preventDefault();
            if (activeIdx > 0) {
                let targetItem = findPrevValidSong(activeIdx);
                if (targetItem) cueRegion(targetItem.start, targetItem.id);
            }
        }

        // DOWN: Reset
        if (event.code === 'ArrowDown') {
            event.preventDefault();
            if (displayList.length > 0) {
                cueRegion(displayList[0].start, displayList[0].id);
            }
        }
    });

    function flashRow(id) {
        let btn = document.querySelector(`#row-${id} .load-btn`);
        if(btn) {
            btn.style.backgroundColor = "#2196F3";
            btn.style.color = "white";
            setTimeout(() => { btn.style.backgroundColor = ""; btn.style.color = ""; }, 200);
        }
    }

    function showHelp(topic) {
        const msgs = {
            scroll: "Auto-Scroll keeps the playing song visible.",
            queue: "Queue Mode ON = seamless transition.\nQueue Mode OFF = instant jump.",
            stop: "Auto-Stop ON = stops at end of region.\n(Use the chain button to override per song)."
        };
        alert(msgs[topic]);
    }

</script>
</body>
</html>
