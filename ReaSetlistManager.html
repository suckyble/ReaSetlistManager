<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ReaSetlistManager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="main.js"></script>
    <script src="Sortable.min.js"></script>
    
    <style>
        /* --- GLOBAL & THEME --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            color: #eee; margin: 0; padding-bottom: 80px; user-select: none;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- CONTROLS AREA --- */
        .controls { 
            position: sticky; top: 0; z-index: 100; 
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            padding: 16px; 
            border-bottom: 2px solid #0f3460;
            display: flex; flex-direction: column; gap: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.6);
        }

        .setlist-row { 
            display: flex; gap: 8px; 
            background: rgba(42, 42, 42, 0.6); 
            padding: 10px; border-radius: 12px; 
            align-items: center; 
            border: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
        }
        .setlist-select {
            flex-grow: 1; padding: 10px 12px; 
            background: rgba(17, 17, 17, 0.8); color: #fff; 
            border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 8px; 
            font-size: 14px; outline: none; min-width: 100px;
        }
        .btn-mini {
            padding: 10px 14px; font-weight: bold; cursor: pointer; 
            border: 1px solid transparent; background: rgba(51, 51, 51, 0.8);
            color: #ccc; border-radius: 8px; font-size: 14px;
        }
        .btn-add { background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%); color: white; }
        .btn-del { background: linear-gradient(135deg, #c62828 0%, #f44336 100%); color: white; }
        .btn-exp { background: linear-gradient(135deg, #1565C0 0%, #2196F3 100%); color: white; }
        .btn-imp { background: linear-gradient(135deg, #EF6C00 0%, #FF9800 100%); color: white; }

        .transport-row { display: flex; gap: 12px; width: 100%; }
        .btn-transport { 
            flex: 1; padding: 16px 0; font-size: 16px; font-weight: bold; 
            cursor: pointer; border-radius: 10px; border: none; color: white;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
        }
        .btn-play { background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%); }
        .btn-stop { background: linear-gradient(135deg, #b71c1c 0%, #d32f2f 100%); }
        .btn-refresh { background: linear-gradient(135deg, #37474f 0%, #546e7a 100%); }

        .toggles-row { 
            display: flex; justify-content: space-around; 
            background: rgba(37, 37, 37, 0.6); padding: 12px; border-radius: 12px;
        }
        .toggle-wrapper { 
            display: flex; align-items: center; gap: 10px; 
            font-size: 11px; text-transform: uppercase; color: #aaa; font-weight: 600;
        }
        .help-icon {
            display: inline-flex; justify-content: center; align-items: center;
            width: 18px; height: 18px; border-radius: 50%;
            background: #546e7a; color: #fff; font-weight: bold; font-size: 11px;
            cursor: pointer; margin-left: 2px;
        }

        .info-row {
            display: flex; justify-content: space-between; padding: 12px 16px; 
            font-size: 16px; color: #90caf9; font-weight: bold; font-family: monospace;
            background: rgba(0,0,0,0.2); border-radius: 8px;
        }

        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { 
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; 
            background: #455a64; transition: .4s; border-radius: 34px;
        }
        .slider:before { 
            position: absolute; content: ""; height: 16px; width: 16px; 
            left: 3px; bottom: 3px; background-color: white; 
            transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background: #2196F3; }
        input:checked + .slider:before { transform: translateX(18px); }

        /* --- SETLIST LIST --- */
        #setlist { 
            list-style: none; padding: 16px; margin: 0; 
            counter-reset: song-counter; 
            overflow-y: auto; -webkit-overflow-scrolling: touch; 
        }
        .region-item { 
            background: linear-gradient(135deg, rgba(37, 37, 37, 0.8) 0%, rgba(30, 30, 40, 0.8) 100%);
            margin-bottom: 12px; padding: 14px; border-radius: 12px;
            display: flex; align-items: center; gap: 12px; 
            border-left: 4px solid #37474f; counter-increment: song-counter; 
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .region-item.active { 
            background: rgba(46, 125, 50, 0.3); border-left-color: #00e676;
        }
        .region-item.queued { 
            border-left-color: #ffd54f; background: rgba(255, 213, 79, 0.15);
        }
        .region-item.skipped {
            opacity: 0.4; border-left-color: #444; background: #1a1a1a;
        }
        
        /* --- DRAG & DROP OPTIMIZED --- */
        /* REMOVED Opacity change to save CPU */
        .sortable-fallback { 
            background: #222 !important; 
            box-shadow: none !important; 
            transform: translateZ(0); 
            pointer-events: none !important; 
            z-index: 99999; 
            border: 2px solid #00e676; 
            border-radius: 12px; 
            transition: none !important;
        }
        .sortable-ghost { 
            opacity: 0.3 !important; background: #eee !important; border: 2px dashed #999 !important; 
        }

        .region-index {
            font-size: 20px; font-weight: 800; color: #546e7a; 
            min-width: 36px; text-align: center; padding: 4px 0; border-radius: 8px;
        }
        .region-index::before { content: counter(song-counter); }
        .region-index.colored { color: #fff; }

        .drag-handle { 
            font-size: 24px; color: #607d8b; padding: 5px; 
            cursor: grab; line-height: 1; touch-action: none; 
        }
        
        .song-info { flex-grow: 1; min-width: 0; }
        .song-header { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: baseline; }
        .song-name { font-weight: 600; color: #fff; font-size: 1.1em; }
        .song-duration { 
            font-family: monospace; color: #90a4ae; font-weight: 500; font-size: 0.95em;
            min-width: 50px; text-align: right;
        }
        .song-duration.live-time { color: #00e676; font-weight: 800; }
        
        .progress-bg { 
            background: rgba(17, 17, 17, 0.6); height: 6px; width: 100%; border-radius: 10px; overflow: hidden; 
        }
        .progress-fill { background: #00e676; height: 100%; width: 0%; }
        
        .song-actions { display: flex; flex-direction: column; gap: 8px; align-items: flex-end; }
        .btn-row-group { display: flex; gap: 6px; width: 100%; }

        .load-btn { 
            background: rgba(33, 150, 243, 0.2); color: #64b5f6; 
            border: 1px solid rgba(33, 150, 243, 0.5); border-radius: 8px; 
            padding: 8px 14px; font-size: 12px; font-weight: bold; width: 100%;
        }
        .chain-btn, .skip-btn {
            background: rgba(51, 51, 51, 0.6); color: #78909c;
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; 
            padding: 6px; width: 50%; text-align: center;
        }
        .chain-btn.linked { background: #2e7d32; color: #a5d6a7; }
        .skip-btn.skipped { background: #c62828; color: #ef9a9a; }
        #setlist .region-item:last-child .chain-btn { visibility: hidden; }

        @media (max-width: 600px) {
            .controls { padding: 8px; gap: 8px; }
            .setlist-row { padding: 6px; gap: 4px; }
            .region-item { padding: 10px; gap: 8px; }
        }
    </style>
</head>
<body>

<div class="controls">
    <div class="setlist-row">
        <select id="setlistSelect" class="setlist-select" onchange="changeSetlist()"></select>
        <button class="btn-mini btn-add" onclick="createSetlist()">+</button>
        <button class="btn-mini btn-del" onclick="deleteSetlist()">&#10005;</button>
        <button class="btn-mini btn-exp" onclick="exportSetlists()">&#8595;</button>
        <button class="btn-mini btn-imp" onclick="triggerImport()">&#8593;</button>
        <input type="file" id="importInput" style="display:none" accept=".json" onchange="importSetlists(this)">
    </div>

    <div class="toggles-row">
        <div class="toggle-wrapper">
            <label class="switch"><input type="checkbox" id="autoScrollToggle" checked><span class="slider round"></span></label>
            <span>Auto-Scroll</span>
        </div>
        <div class="toggle-wrapper">
            <label class="switch"><input type="checkbox" id="queueModeToggle"><span class="slider round"></span></label>
            <span>Queue Mode</span>
        </div>
        <div class="toggle-wrapper">
            <label class="switch"><input type="checkbox" id="autoStopToggle" checked><span class="slider round"></span></label>
            <span>Auto-Stop</span>
        </div>
    </div>

    <div class="info-row">
        <span id="song-count">Active: 0</span>
        <span id="total-time">Time: 0:00</span>
    </div>

    <div class="transport-row">
        <button class="btn-transport btn-play" onclick="togglePlay()">&#9654; PLAY</button>
        <button class="btn-transport btn-stop" onclick="smartStop()">&#9632; STOP</button>
        <button class="btn-transport btn-refresh" onclick="wwr_start()">&#8635; RESYNC</button>
    </div>
</div>

<ul id="setlist"></ul>

<script type="text/javascript">
    // --- 0. CRITICAL ANDROID 5 POLYFILLS ---
    (function() {
        if (!Array.from) {
            Array.from = (function () {
                var toStr = Object.prototype.toString;
                var isCallable = function (fn) { return typeof fn === 'function' || toStr.call(fn) === '[object Function]'; };
                var toInteger = function (value) { var number = Number(value); if (isNaN(number)) { return 0; } if (number === 0 || !isFinite(number)) { return number; } return (number > 0 ? 1 : -1) * Math.floor(Math.abs(number)); };
                var maxSafeInteger = Math.pow(2, 53) - 1;
                var toLength = function (value) { var len = toInteger(value); return Math.min(Math.max(len, 0), maxSafeInteger); };
                return function from(arrayLike) { var C = this; var items = Object(arrayLike); if (arrayLike == null) { throw new TypeError('Array.from requires an array-like object - not null or undefined'); } var mapFn = arguments.length > 1 ? arguments[1] : undefined; var T; if (typeof mapFn !== 'undefined') { if (!isCallable(mapFn)) { throw new TypeError('Array.from: when provided, the second argument must be a function'); } if (arguments.length > 2) { T = arguments[2]; } } var len = toLength(items.length); var A = isCallable(C) ? Object(new C(len)) : new Array(len); var k = 0; var kValue; while (k < len) { kValue = items[k]; if (mapFn) { A[k] = typeof T === 'undefined' ? mapFn(kValue, k) : mapFn.call(T, kValue, k); } else { A[k] = kValue; } k += 1; } A.length = len; return A; };
            }());
        }
        if (typeof Object.assign !== 'function') {
            Object.assign = function(target) {
                'use strict';
                if (target == null) { throw new TypeError('Cannot convert undefined or null to object'); }
                target = Object(target);
                for (var index = 1; index < arguments.length; index++) {
                    var source = arguments[index];
                    if (source != null) {
                        for (var key in source) {
                            if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; }
                        }
                    }
                }
                return target;
            };
        }
        if (!Element.prototype.matches) { Element.prototype.matches = Element.prototype.msMatchesSelector || Element.prototype.webkitMatchesSelector; }
        if (!Element.prototype.closest) {
            Element.prototype.closest = function(s) {
                var el = this;
                do { if (el.matches(s)) return el; el = el.parentElement || el.parentNode; } while (el !== null && el.nodeType === 1);
                return null;
            };
        }
        if (!Array.prototype.find) {
            Array.prototype.find = function(predicate) {
                if (this == null) throw new TypeError('Array.prototype.find called on null or undefined');
                if (typeof predicate !== 'function') throw new TypeError('predicate must be a function');
                var list = Object(this); var length = list.length >>> 0; var thisArg = arguments[1];
                for (var i = 0; i < length; i++) { var value = list[i]; if (predicate.call(thisArg, value, i, list)) return value; }
                return undefined;
            };
        }
        if (!Array.prototype.findIndex) {
            Array.prototype.findIndex = function(predicate) {
                if (this == null) throw new TypeError('Array.prototype.findIndex called on null or undefined');
                if (typeof predicate !== 'function') throw new TypeError('predicate must be a function');
                var list = Object(this); var length = list.length >>> 0; var thisArg = arguments[1];
                for (var i = 0; i < length; i++) { var value = list[i]; if (predicate.call(thisArg, value, i, list)) return i; }
                return -1;
            };
        }
    })();

    // --- 1. REAPER CONNECTION ---
    wwr_req_recur("TRANSPORT", 100);
    wwr_req_recur("REGION", 1000); 
    wwr_start(); 

    // --- 2. STATE ---
    var g_regions = [];      
    var displayList = [];    
    var isPlaying = false;
    var currentPos = 0.0;
    var queuedRegion = null;
    var lastActiveID = null;
    var lastRenderChecksum = "";
    var isDragging = false;
    var initialized = false;

    // STORAGE
    var STORAGE_KEY = "reaper_setlists_v9"; 
    var CURRENT_KEY = "reaper_current_setlist";
    var setlists = JSON.parse(localStorage.getItem(STORAGE_KEY)) || { "Default": [] };
    var currentSetlistName = localStorage.getItem(CURRENT_KEY) || "Default";
    if (!setlists["Default"]) setlists["Default"] = [];
    if (!setlists[currentSetlistName]) currentSetlistName = "Default";

    updateSetlistDropdown();

    // --- 3. LISTENER ---
    function wwr_onreply(results) {
        if (isDragging) return;
        var ar = results.split("\n");
        for (var x = 0; x < ar.length; x++) {
            var tok = ar[x].split("\t");
            if (tok.length > 0) {
                if (tok[0] === "TRANSPORT") {
                    isPlaying = (tok[1] & 1) == 1;
                    currentPos = parseFloat(tok[2]);
                    updatePlaybackUI(); 
                }
                else if (tok[0] === "REGION_LIST") g_regions = [];
                else if (tok[0] === "REGION") g_regions.push(tok);
                else if (tok[0] === "REGION_LIST_END") syncRegions();
            }
        }
    }

    // --- 4. SYNC LOGIC ---
    function syncRegions() {
        if (isDragging) return;
        var reaperMap = {};
        for (var i = 0; i < g_regions.length; i++) {
            var r = g_regions[i];
            if (r.length > 4) {
                var rawColor = r.length > 5 ? parseInt(r[5]) : 0;
                var cssColor = null;
                if (rawColor > 0) {
                     cssColor = '#' + (rawColor & 0xFFFFFF).toString(16);
                     while (cssColor.length < 7) { cssColor = "#0" + cssColor.substr(1); }
                }
                reaperMap[r[2]] = { 
                    name: r[1], id: r[2], start: parseFloat(r[3]), end: parseFloat(r[4]),
                    duration: parseFloat(r[4]) - parseFloat(r[3]), color: cssColor 
                };
            }
        }
        if (displayList.length === 0 && !initialized) {
            var savedList = setlists[currentSetlistName];
            for (var j = 0; j < savedList.length; j++) {
                var item = savedList[j];
                if (reaperMap.hasOwnProperty(item.id)) {
                    var rData = reaperMap[item.id];
                    rData.chain = item.chain;
                    rData.skipped = (item.skipped === true);
                    displayList.push(rData);
                    delete reaperMap[item.id];
                }
            }
            var newItems = [];
            for (var key in reaperMap) { if (reaperMap.hasOwnProperty(key)) newItems.push(reaperMap[key]); }
            newItems.sort(function(a,b) { return a.start - b.start; });
            for (var k = 0; k < newItems.length; k++) {
                var d = newItems[k]; d.chain = false; d.skipped = false; displayList.push(d);
            }
            if (displayList.length > 0 && !isPlaying) wwr_req("SET/POS/" + displayList[0].start);
            initialized = true;
        } else {
            var activeIDs = {}; 
            for (var m = 0; m < displayList.length; m++) {
                var item = displayList[m];
                if (reaperMap.hasOwnProperty(item.id)) {
                    var rData = reaperMap[item.id];
                    item.name = rData.name; item.start = rData.start; item.end = rData.end;
                    item.duration = rData.duration; item.color = rData.color; 
                    activeIDs[item.id] = true; delete reaperMap[item.id];
                }
            }
            var filtered = [];
            for (var n = 0; n < displayList.length; n++) {
                var it = displayList[n];
                if (activeIDs[it.id] || reaperMap.hasOwnProperty(it.id)) filtered.push(it);
            }
            displayList = filtered;
            var newItems2 = [];
            for (var key2 in reaperMap) { if (reaperMap.hasOwnProperty(key2)) newItems2.push(reaperMap[key2]); }
            newItems2.sort(function(a,b) { return a.start - b.start; });
            for (var p = 0; p < newItems2.length; p++) {
                var d2 = newItems2[p]; d2.chain = false; d2.skipped = false; displayList.push(d2);
            }
        }
        saveCurrentState();
        var currentChecksum = JSON.stringify(displayList.map(function(r){ return { id: r.id, chain: r.chain, skipped: r.skipped, name: r.name, color: r.color }; }));
        if (currentChecksum !== lastRenderChecksum) {
            lastRenderChecksum = currentChecksum; renderSetlist(); updatePlaybackUI();
        }
    }

    function saveCurrentState() {
        var storageFormat = displayList.map(function(r){ return { id: r.id, chain: r.chain, skipped: r.skipped }; });
        setlists[currentSetlistName] = storageFormat;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(setlists));
        localStorage.setItem(CURRENT_KEY, currentSetlistName);
    }

    // --- 5. RENDER ---
    function formatTime(seconds) {
        var m = Math.floor(seconds / 60); var s = Math.round(seconds % 60);
        return m + ":" + (s < 10 ? '0' : '') + s;
    }
    function formatTotalTime(seconds) {
        var h = Math.floor(seconds / 3600); var m = Math.floor((seconds % 3600) / 60); var s = Math.round(seconds % 60);
        return (h > 0 ? h + ":" : "") + (h > 0 && m < 10 ? "0" : "") + m + ":" + (s < 10 ? "0" : "") + s;
    }

    function renderSetlist() {
        var listEl = document.getElementById('setlist');
        var scrollPos = listEl.scrollTop;
        listEl.innerHTML = "";
        var totalDuration = 0; var activeCount = 0;
        
        for(var i=0; i<displayList.length; i++) {
            var r = displayList[i];
            if (!r.skipped) { totalDuration += r.duration; activeCount++; }

            var li = document.createElement("li");
            li.className = "region-item" + (r.skipped ? " skipped" : "");
            li.id = "row-" + r.id; li.setAttribute("data-id", r.id);
            
            var chainIcon = r.chain ? "&#10140;" : "&#9632;";
            var chainClass = r.chain ? "chain-btn linked" : "chain-btn";
            var skipIcon = r.skipped ? "&#10004;" : "&#10006;";
            var skipClass = r.skipped ? "skip-btn skipped" : "skip-btn";
            var indexStyle = r.color ? 'background-color: ' + r.color + ';' : '';
            var indexClass = r.color ? 'region-index colored' : 'region-index';
            
            var html = '';
            html += '<div class="' + indexClass + '" style="' + indexStyle + '"></div>';
            html += '<div class="drag-handle">&#9776;</div>';
            html += '<div class="song-info">';
            html += '  <div class="song-header">';
            html += '    <span class="song-name">' + r.name + '</span>';
            html += '    <span class="song-duration" id="dur-' + r.id + '" data-length="' + formatTime(r.duration) + '">' + formatTime(r.duration) + '</span>';
            html += '  </div>';
            html += '  <div class="progress-bg"><div class="progress-fill" id="prog-' + r.id + '"></div></div>';
            html += '</div>';
            html += '<div class="song-actions">';
            html += '  <div class="btn-row-group">';
            html += '    <button class="' + chainClass + '" onclick="toggleChain(\'' + r.id + '\')" title="Follow Action">' + chainIcon + '</button>';
            html += '    <button class="' + skipClass + '" onclick="toggleSkip(\'' + r.id + '\')" title="Skip Song">' + skipIcon + '</button>';
            html += '  </div>';
            html += '  <button class="load-btn" onclick="playRegion(' + r.start + ', \'' + r.id + '\')">PLAY NEXT</button>';
            html += '</div>';
            
            li.innerHTML = html;
            listEl.appendChild(li);
        }
        listEl.scrollTop = scrollPos;
        document.getElementById('song-count').innerText = "Active: " + activeCount;
        document.getElementById('total-time').innerText = "Time: " + formatTotalTime(totalDuration);
    }

    // --- 6. ACTIONS ---
    function toggleChain(id) {
        var item = null; for(var i=0; i<displayList.length; i++) { if(displayList[i].id == id) { item = displayList[i]; break; } }
        if (item) { item.chain = !item.chain; saveCurrentState(); lastRenderChecksum = ""; syncRegions(); }
    }
    function toggleSkip(id) {
        var item = null; for(var i=0; i<displayList.length; i++) { if(displayList[i].id == id) { item = displayList[i]; break; } }
        if (item) { item.skipped = !item.skipped; saveCurrentState(); lastRenderChecksum = ""; syncRegions(); }
    }
    function findNextValidSong(startIndex) {
        for (var i = startIndex + 1; i < displayList.length; i++) { if (!displayList[i].skipped) return displayList[i]; }
        return null;
    }
    function findPrevValidSong(startIndex) {
        for (var i = startIndex - 1; i >= 0; i--) { if (!displayList[i].skipped) return displayList[i]; }
        return null;
    }

    // --- 7. PLAYBACK ---
    function updatePlaybackUI() {
        if (isDragging) return;
        var previousActive = document.querySelector('.region-item.active');
        if (previousActive) previousActive.classList.remove('active');
        var fills = document.querySelectorAll('.progress-fill');
        for(var i=0; i<fills.length; i++) { fills[i].style.width = '0%'; }

        var activeIdx = -1;
        for(var j=0; j<displayList.length; j++) {
            var r = displayList[j];
            if (currentPos >= r.start && currentPos <= r.end) { activeIdx = j; break; }
        }
        var activeRegion = (activeIdx !== -1) ? displayList[activeIdx] : null;

        if (lastActiveID && (!activeRegion || activeRegion.id !== lastActiveID)) {
            var oldDur = document.getElementById("dur-" + lastActiveID);
            if (oldDur) { oldDur.innerText = oldDur.getAttribute("data-length"); oldDur.classList.remove("live-time"); }
        }

        if (activeRegion) {
            if (activeRegion.skipped) {
                var next = findNextValidSong(activeIdx);
                if (next) { wwr_req("SET/POS/" + next.start); return; }
            }
            var row = document.getElementById("row-" + activeRegion.id);
            if (row) {
                row.classList.add('active');
                if (activeRegion.id !== lastActiveID) {
                    lastActiveID = activeRegion.id;
                    if (document.getElementById('autoScrollToggle').checked && row.scrollIntoView) {
                        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
                var percent = ((currentPos - activeRegion.start) / activeRegion.duration) * 100;
                var bar = document.getElementById("prog-" + activeRegion.id);
                if (bar) bar.style.width = Math.min(100, Math.max(0, percent)) + "%";
                var durEl = document.getElementById("dur-" + activeRegion.id);
                if (durEl) {
                    var remaining = activeRegion.end - currentPos;
                    if (remaining < 0) remaining = 0;
                    durEl.innerText = "-" + formatTime(remaining); durEl.classList.add("live-time");
                }
            }
            var timeRemaining = activeRegion.end - currentPos;
            if (timeRemaining <= 0.2 && timeRemaining > -1 && isPlaying) {
                if (queuedRegion) {
                    wwr_req("SET/POS/" + queuedRegion.start); queuedRegion = null;
                    var queuedEls = document.querySelectorAll('.region-item');
                    for(var k=0; k<queuedEls.length; k++) queuedEls[k].classList.remove('queued');
                    return;
                } 
                var shouldPlayNext = false;
                if (activeRegion.chain) shouldPlayNext = true;
                else if (!document.getElementById('autoStopToggle').checked) shouldPlayNext = true;

                if (shouldPlayNext) {
                    var nextRegion = findNextValidSong(activeIdx);
                    if (nextRegion) { wwr_req("SET/POS/" + nextRegion.start); return; }
                }
                if (document.getElementById('autoStopToggle').checked && !activeRegion.chain) {
                    wwr_req(1016); 
                    var nextRegion2 = findNextValidSong(activeIdx);
                    if (nextRegion2) { setTimeout(function() { wwr_req("SET/POS/" + nextRegion2.start); }, 100); }
                }
            }
        }
    }

    function playRegion(start, id) {
        var queueMode = document.getElementById('queueModeToggle').checked;
        if (!isPlaying || !queueMode) {
            wwr_req("SET/POS/" + start); wwr_req(1007); queuedRegion = null;
            var allItems = document.querySelectorAll('.region-item');
            for(var i=0; i<allItems.length; i++) allItems[i].classList.remove('queued');
        } else {
            for(var j=0; j<displayList.length; j++) { if (displayList[j].id == id) { queuedRegion = displayList[j]; break; } }
            var allItems2 = document.querySelectorAll('.region-item');
            for(var k=0; k<allItems2.length; k++) allItems2[k].classList.remove('queued');
            var row = document.getElementById("row-" + id);
            if (row) row.classList.add('queued');
        }
    }
    
    function cueRegion(start, id) { wwr_req(1016); wwr_req("SET/POS/" + start); flashRow(id); }
    
    function smartStop() {
        var activeIdx = -1;
        for(var i=0; i<displayList.length; i++) {
            var r = displayList[i]; if (currentPos >= r.start && currentPos <= r.end) { activeIdx = i; break; }
        }
        var targetPos = null;
        if (activeIdx !== -1) targetPos = displayList[activeIdx].start;
        else if (displayList.length > 0) targetPos = displayList[0].start; 
        wwr_req(1016); if (targetPos !== null) setTimeout(function() { wwr_req("SET/POS/" + targetPos); }, 150);
    }
    
    function togglePlay() {
        if (isPlaying) { wwr_req(1008); } 
        else {
            var activeIdx = -1;
            for(var i=0; i<displayList.length; i++) {
                var r = displayList[i]; if (currentPos >= r.start && currentPos <= r.end) { activeIdx = i; break; }
            }
            if (activeIdx === -1 && displayList.length > 0) playRegion(displayList[0].start, displayList[0].id);
            else wwr_req(1007);
        }
    }

    // --- 8. FILE IO ---
    function updateSetlistDropdown() {
        var sel = document.getElementById("setlistSelect"); sel.innerHTML = "";
        for (var name in setlists) {
            if(setlists.hasOwnProperty(name)) {
                var opt = document.createElement("option"); opt.value = name; opt.text = name;
                if (name === currentSetlistName) opt.selected = true; sel.appendChild(opt);
            }
        }
    }
    function createSetlist() {
        var name = prompt("Name for new setlist?");
        if (name && !setlists[name]) {
            setlists[name] = displayList.map(function(r){ return { id: r.id, chain: r.chain, skipped: r.skipped }; });
            currentSetlistName = name; saveCurrentState(); updateSetlistDropdown(); displayList = []; initialized = false; syncRegions();
        }
    }
    function deleteSetlist() {
        if (currentSetlistName === "Default") return alert("Cannot delete Default.");
        if (confirm("Delete " + currentSetlistName + "?")) {
            delete setlists[currentSetlistName]; currentSetlistName = "Default"; saveCurrentState(); updateSetlistDropdown(); displayList = []; initialized = false; syncRegions();
        }
    }
    function changeSetlist() {
        currentSetlistName = document.getElementById("setlistSelect").value;
        localStorage.setItem(CURRENT_KEY, currentSetlistName); displayList = []; initialized = false; syncRegions();
    }
    function exportSetlists() {
        var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(setlists, null, 2));
        var downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr); downloadAnchorNode.setAttribute("download", "reaper_setlists.json");
        document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove();
    }
    function triggerImport() { document.getElementById('importInput').click(); }
    function importSetlists(input) {
        var file = input.files[0]; if (!file) return;
        var reader = new FileReader();
        reader.onload = function(e) {
            try {
                var importedData = JSON.parse(e.target.result);
                if (importedData && typeof importedData === 'object' && importedData["Default"]) {
                    if(confirm("Overwrite all local setlists?")) {
                        setlists = importedData; if (!setlists[currentSetlistName]) currentSetlistName = "Default";
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(setlists)); localStorage.setItem(CURRENT_KEY, currentSetlistName);
                        updateSetlistDropdown(); displayList = []; initialized = false; syncRegions(); alert("Import Successful!");
                    }
                } else { alert("Invalid File Format."); }
            } catch (err) { alert("Error reading file."); }
        }; reader.readAsText(file); input.value = '';
    }

    // --- 9. DRAG & DROP (ROBUST) ---
    // Prevent Scroll Hijack
    document.addEventListener('touchmove', function(e) { if (isDragging) { e.preventDefault(); } }, { passive: false });

    new Sortable(document.getElementById('setlist'), {
        animation: 0,
        handle: '.drag-handle',
        forceFallback: true,      
        fallbackOnBody: true,
        
        // --- DELAY REMOVED ---
        delay: 0,               
        
        scroll: true,             
        scrollSensitivity: 50,    
        ghostClass: 'sortable-ghost',
        fallbackClass: 'sortable-fallback',

        onStart: function (evt) {
            isDragging = true;
            document.body.style.overflow = 'hidden'; // Lock Body
        },
        
        onEnd: function (evt) {
            isDragging = false;
            document.body.style.overflow = ''; // Unlock Body
            
            var items = document.querySelectorAll("#setlist .region-item");
            var newOrder = []; var sortedDisplay = [];
            
            for (var i = 0; i < items.length; i++) {
                var id = items[i].getAttribute("data-id");
                var existing = null;
                for(var k=0; k<displayList.length; k++) { if(displayList[k].id == id) { existing = displayList[k]; break; } }
                if (existing) {
                    newOrder.push({ id: id, chain: existing.chain, skipped: existing.skipped });
                    sortedDisplay.push(existing);
                }
            }
            setlists[currentSetlistName] = newOrder;
            saveCurrentState();
            displayList = sortedDisplay;
            lastRenderChecksum = JSON.stringify(displayList.map(function(r){ 
                return { id: r.id, chain: r.chain, skipped: r.skipped, name: r.name, color: r.color }; 
            }));
        }
    });

    // --- 10. KEYBOARD CONTROLS ---
    document.addEventListener('keydown', function(event) {
        var activeIdx = -1;
        for(var i=0; i<displayList.length; i++) {
            var r = displayList[i]; if (currentPos >= r.start && currentPos <= r.end) { activeIdx = i; break; }
        }
        if (event.code === 'Space') { event.preventDefault(); togglePlay(); }
        if (event.code === 'Enter') { event.preventDefault(); smartStop(); }
        if (event.code === 'ArrowLeft') { event.preventDefault(); if (activeIdx !== -1) { playRegion(displayList[activeIdx].start, displayList[activeIdx].id); flashRow(displayList[activeIdx].id); } }
        if (event.code === 'ArrowRight') { event.preventDefault(); var t = (activeIdx === -1) ? (displayList.find(function(x){return !x.skipped})||null) : findNextValidSong(activeIdx); if(t) cueRegion(t.start, t.id); }
        if (event.code === 'ArrowUp') { event.preventDefault(); if (activeIdx > 0) { var t2 = findPrevValidSong(activeIdx); if (t2) cueRegion(t2.start, t2.id); } }
        if (event.code === 'ArrowDown') { event.preventDefault(); if (displayList.length > 0) cueRegion(displayList[0].start, displayList[0].id); }
    });

    function flashRow(id) {
        var btn = document.querySelector("#row-" + id + " .load-btn");
        if(btn) {
            btn.style.backgroundColor = "#2196F3"; btn.style.color = "white";
            setTimeout(function() { btn.style.backgroundColor = ""; btn.style.color = ""; }, 200);
        }
    }
</script>
</body>
</html>
